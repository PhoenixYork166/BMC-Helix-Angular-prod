{"version":3,"file":"approval-console.service.js","sourceRoot":"","sources":["../../../../../../../libs/platform/approval/components/approval-console/approval-console.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { HttpClient } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport {\r\n  ApprovalCommandType,\r\n  IApprovalCommand,\r\n  IApprovalRequest,\r\n  IApprovalRequestCounts,\r\n  IRequestAdditionalFields\r\n} from './approval-console.types';\r\nimport {\r\n  IDataPageParams,\r\n  IDataPageResult,\r\n  RX_APPLICATION,\r\n  RX_RESOURCE_URLS,\r\n  RxCurrentUserService\r\n} from '@helix/platform/shared/api';\r\nimport { RX_APPROVAL_CONSOLE } from './approval-console.constant';\r\nimport { RX_RECORD_DEFINITION, RxRecordInstanceUtilsService } from '@helix/platform/record/api';\r\nimport { IRxSelectWithPaginationOptionsPage } from '@helix/platform/shared/components';\r\nimport { map } from 'rxjs/operators';\r\nimport { RxApprovalUsersDataPageService } from './approval-request-reassign/approval-users-data-page.service';\r\nimport { RxSignatureDetailDataPageService } from './signature-detail-data-page.service';\r\nimport { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class RxApprovalConsoleService {\r\n  constructor(\r\n    private httpClient: HttpClient,\r\n    private rxSignatureDetailDataPageService: RxSignatureDetailDataPageService,\r\n    private rxCurrentUserService: RxCurrentUserService,\r\n    private rxRecordInstanceUtilsService: RxRecordInstanceUtilsService,\r\n    private rxApprovalUsersDataPageService: RxApprovalUsersDataPageService\r\n  ) {}\r\n\r\n  getApprovalRequestCounts(): Observable<IApprovalRequestCounts> {\r\n    return this.httpClient.get<IApprovalRequestCounts>(\r\n      `/api/${RX_APPLICATION.approvalBundleId}/rx/application/approval/counts?ignoreAlternateUser=false`\r\n    );\r\n  }\r\n\r\n  getRequestLabelDetails(\r\n    registeredDefinitionName: string,\r\n    approvalFlowName: string\r\n  ): Observable<IRequestAdditionalFields> {\r\n    return this.httpClient.get<IRequestAdditionalFields>(\r\n      `/api/${RX_APPLICATION.approvalBundleId}/rx/application/approval/labels/${encodeURIComponent(\r\n        registeredDefinitionName\r\n      )}/${encodeURIComponent(approvalFlowName)}`\r\n    );\r\n  }\r\n\r\n  getCurrentRequestDetails(requestId: string, application: string): Observable<IApprovalRequest> {\r\n    return this.rxSignatureDetailDataPageService\r\n      .get({\r\n        params: {\r\n          request: requestId,\r\n          application,\r\n          ignoreAssignedUser: true\r\n        }\r\n      })\r\n      .pipe(map((response: IDataPageResult) => response.data[0] as IApprovalRequest));\r\n  }\r\n\r\n  approveRequest(approvalCommands: IApprovalCommand[]): Observable<any> {\r\n    return this.httpClient.post(RX_RESOURCE_URLS.command, {\r\n      resourceType: RX_APPROVAL_CONSOLE.approvalServerCommand,\r\n      commands: approvalCommands\r\n    });\r\n  }\r\n\r\n  rejectRequest(approvalCommands: IApprovalCommand[]): Observable<any> {\r\n    return this.httpClient.post(RX_RESOURCE_URLS.command, {\r\n      resourceType: RX_APPROVAL_CONSOLE.approvalServerCommand,\r\n      commands: approvalCommands\r\n    });\r\n  }\r\n\r\n  holdRequest(approvalCommands: IApprovalCommand[]): Observable<any> {\r\n    return this.httpClient.post(RX_RESOURCE_URLS.command, {\r\n      resourceType: RX_APPROVAL_CONSOLE.approvalServerCommand,\r\n      commands: approvalCommands\r\n    });\r\n  }\r\n\r\n  reassignRequest(approvalCommands: IApprovalCommand[]): Observable<any> {\r\n    return this.httpClient.post(RX_RESOURCE_URLS.command, {\r\n      resourceType: RX_APPROVAL_CONSOLE.approvalServerCommand,\r\n      commands: approvalCommands\r\n    });\r\n  }\r\n\r\n  getCommandPayload(commandType: ApprovalCommandType, requestSignatureInstanceId: string): IApprovalCommand {\r\n    return {\r\n      formName: RX_APPROVAL_CONSOLE.approvalCommandForm,\r\n      requestID: requestSignatureInstanceId,\r\n      command: commandType\r\n    };\r\n  }\r\n\r\n  saveQuestion(formData: FormData, type: string): Observable<any> {\r\n    return this.httpClient.post(\r\n      `/api/${RX_APPLICATION.approvalBundleId}/rx/application/approval/moreinformation/${type}`,\r\n      formData\r\n    );\r\n  }\r\n\r\n  saveAttachment(formData: FormData, guid: string): Observable<any> {\r\n    return this.httpClient.post(\r\n      `${RX_RECORD_DEFINITION.recordInstanceAttachment}/${encodeURIComponent(\r\n        RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.definition\r\n      )}/${guid}`,\r\n      formData\r\n    );\r\n  }\r\n\r\n  getApprovalUsers(\r\n    startIndex: number,\r\n    pageSize: number,\r\n    searchQuery: string\r\n  ): Observable<IRxSelectWithPaginationOptionsPage> {\r\n    const queryParams: IDataPageParams = {\r\n      startIndex: startIndex,\r\n      pageSize: pageSize,\r\n      propertySelection: ['loginName', 'fullName']\r\n    };\r\n\r\n    queryParams.queryExpression = `'${\r\n      RX_APPROVAL_CONSOLE.approvalUserNameField\r\n    }'!=\"${this.rxCurrentUserService.getName()}\"`;\r\n\r\n    if (searchQuery) {\r\n      queryParams.queryExpression +=\r\n        ` AND ('${\r\n          RX_RECORD_DEFINITION.coreFieldIds.description\r\n        }' LIKE \"%${this.rxRecordInstanceUtilsService.escapeTextWildcards(searchQuery)}%\"` +\r\n        ` OR '${\r\n          RX_APPROVAL_CONSOLE.approvalUserNameField\r\n        }' LIKE \"%${this.rxRecordInstanceUtilsService.escapeTextWildcards(searchQuery)}%\")`;\r\n    }\r\n\r\n    return this.rxApprovalUsersDataPageService\r\n      .get({\r\n        params: { startIndex, pageSize, ...queryParams }\r\n      })\r\n      .pipe(\r\n        map((response: IDataPageResult) => ({\r\n          totalSize: response.totalSize,\r\n          options: response.data.map(({ fullName, loginName }) => ({\r\n            displayValue: fullName,\r\n            value: loginName\r\n          }))\r\n        }))\r\n      );\r\n  }\r\n}\r\n"]}