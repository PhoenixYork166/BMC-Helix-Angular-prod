{"version":3,"file":"issue-reporting-configuration.component.js","sourceRoot":"","sources":["../../../../../../../libs/platform/admin/components/issue-reporting-configuration/issue-reporting-configuration.component.ts","../../../../../../../libs/platform/admin/components/issue-reporting-configuration/issue-reporting-configuration.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnInit } from '@angular/core';\nimport { FormBuilder, FormGroup } from '@angular/forms';\nimport { RxCurrentUserService, RxNotificationService } from '@helix/platform/shared/api';\nimport { RxIssueReportingConfigurationService } from './issue-reporting-configuration.service';\nimport { forkJoin, Subscription } from 'rxjs';\nimport { RX_ISSUE_REPORTING_CONFIGURATION } from './issue-reporting-configuration.constant';\nimport {\n  RX_RECORD_DEFINITION,\n  RxRecordInstanceService,\n  RxRecordInstanceUpdateService\n} from '@helix/platform/record/api';\nimport { BaseViewComponent } from '@helix/platform/view/runtime';\nimport { TranslateService } from '@ngx-translate/core';\n\n@Component({\n  selector: 'rx-admin-issue-reporting-configuration',\n  templateUrl: './issue-reporting-configuration.component.html',\n  styleUrls: ['./issue-reporting-configuration.component.scss']\n})\nexport class IssueReportingConfigurationAdminComponent extends BaseViewComponent implements OnInit {\n  issueReportingConfigurationForm: FormGroup;\n  isAdministrator: boolean = this.rxCurrentUserService.isAdministrator();\n  isAccountLinked: boolean;\n  oauthUrl = '';\n  busy: Subscription;\n\n  private configId: string;\n\n  constructor(\n    private formBuilder: FormBuilder,\n    private rxCurrentUserService: RxCurrentUserService,\n    private rxIssueReportingConfigurationService: RxIssueReportingConfigurationService,\n    private rxNotificationService: RxNotificationService,\n    private rxRecordInstanceService: RxRecordInstanceService,\n    private rxRecordInstanceUpdateService: RxRecordInstanceUpdateService,\n    private translateService: TranslateService\n  ) {\n    super();\n  }\n\n  saveConfig(): void {\n    const formValue = this.issueReportingConfigurationForm.getRawValue();\n\n    this.rxIssueReportingConfigurationService.setSupportId(formValue.supportId).subscribe();\n\n    if (this.configId) {\n      this.rxRecordInstanceService\n        .get(RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.recordDefinitionName, this.configId)\n        .subscribe((recordInstance) => {\n          recordInstance.setFieldValue(\n            RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.fieldIds.supportEmail,\n            formValue.supportEmail\n          );\n\n          this.rxRecordInstanceUpdateService.execute(recordInstance).subscribe(() => {\n            this.rxNotificationService.addSuccessMessage(\n              this.translateService.instant(\n                'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.issue-reporting-configuration-updated.message'\n              )\n            );\n            this.issueReportingConfigurationForm.markAsPristine();\n          });\n        });\n    } else {\n      this.rxRecordInstanceService\n        .getNew(RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.recordDefinitionName)\n        .subscribe((recordInstance) => {\n          recordInstance.setFieldValue(\n            RX_RECORD_DEFINITION.coreFieldIds.description,\n            this.translateService.instant(RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.defaultDescription)\n          );\n\n          recordInstance.setFieldValue(\n            RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.fieldIds.supportEmail,\n            formValue.supportEmail\n          );\n\n          recordInstance.setFieldValue(\n            RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.fieldIds.loginName,\n            this.rxCurrentUserService.getName()\n          );\n\n          this.rxRecordInstanceService.create(recordInstance).subscribe(() => {\n            this.rxNotificationService.addSuccessMessage(\n              this.translateService.instant(\n                'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.issue-reporting-configuration-saved.message'\n              )\n            );\n            this.issueReportingConfigurationForm.markAsPristine();\n          });\n        });\n    }\n  }\n\n  private getOauthData(): void {\n    this.busy = this.rxIssueReportingConfigurationService.getOauthConfig().subscribe((data) => {\n      this.oauthUrl = data.authorizeURL;\n      this.isAccountLinked = data.configured;\n    });\n  }\n\n  openWindow(): void {\n    const title = 'BMC Cloud Service';\n    const openedWindow = window.open(this.oauthUrl, title, 'scrollbars=1,height=600,width=670');\n\n    this.assertWindowClosed(openedWindow);\n  }\n\n  private assertWindowClosed(openedWindow: Window): void {\n    const interval = setInterval(() => {\n      if (!openedWindow || !openedWindow.closed) {\n        return;\n      }\n\n      clearInterval(interval);\n      this.getOauthData();\n    }, 100);\n  }\n\n  ngOnInit(): void {\n    this.notifyPropertyChanged('api', {\n      isDirty: () => this.issueReportingConfigurationForm?.dirty\n    });\n\n    if (this.isAdministrator) {\n      this.issueReportingConfigurationForm = this.formBuilder.group({\n        supportId: '',\n        supportEmail: ''\n      });\n\n      this.busy = forkJoin({\n        supportId: this.rxIssueReportingConfigurationService.getSupportId(),\n        supportConfig: this.rxIssueReportingConfigurationService.getSupportConfig()\n      }).subscribe((result) => {\n        let supportEmail = '';\n\n        if (result.supportConfig) {\n          this.configId = result.supportConfig[RX_RECORD_DEFINITION.coreFieldIds.id];\n          supportEmail =\n            result.supportConfig[RX_ISSUE_REPORTING_CONFIGURATION.supportUserMapping.fieldIds.supportEmail];\n        }\n\n        this.issueReportingConfigurationForm.patchValue({\n          supportId: result.supportId,\n          supportEmail\n        });\n      });\n\n      this.getOauthData();\n    }\n  }\n}\n","<rx-admin-settings\n  header=\"{{ 'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.header.title' | translate }}\"\n  [busy]=\"busy\"\n>\n  <adapt-accordion multiselect=\"true\" class=\"pb-4\">\n    <form [formGroup]=\"issueReportingConfigurationForm\" *ngIf=\"isAdministrator\">\n      <adapt-accordion-tab\n        title=\"{{\n          'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.bmc-service-cloud-account-configuration.label'\n            | translate\n        }}\"\n        isOpen=\"true\"\n      >\n        <adapt-rx-textfield\n          rx-id=\"support-id\"\n          label=\"Support ID\"\n          formControlName=\"supportId\"\n          required=\"true\"\n          class=\"d-block form-group\"\n        >\n        </adapt-rx-textfield>\n        <adapt-rx-textfield\n          rx-id=\"support-email\"\n          label=\"Support email\"\n          formControlName=\"supportEmail\"\n          required=\"true\"\n          email=\"true\"\n          class=\"d-block form-group\"\n        >\n        </adapt-rx-textfield>\n      </adapt-accordion-tab>\n\n      <adapt-accordion-tab title=\"Link BMC Service Cloud account to BMC Helix platform\" isOpen=\"true\" class=\"d-block\">\n        <adapt-alert\n          *ngIf=\"oauthUrl === null\"\n          class=\"py-2\"\n          [config]=\"{\n            content:\n              'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.issue-reporting-configuration-missing.message'\n              | translate,\n            type: 'inline',\n            variant: 'danger'\n          }\"\n        ></adapt-alert>\n        <ng-container *ngIf=\"oauthUrl\">\n          <adapt-alert\n            *ngIf=\"isAccountLinked\"\n            class=\"py-2\"\n            [config]=\"{\n              content:\n                'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.account-is-linked.message' | translate,\n              type: 'inline',\n              variant: 'success'\n            }\"\n          ></adapt-alert>\n          <adapt-alert\n            *ngIf=\"!isAccountLinked\"\n            class=\"py-2\"\n            [config]=\"{\n              content:\n                'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.account-is-not-linked.message' | translate,\n              type: 'inline',\n              variant: 'warning'\n            }\"\n          ></adapt-alert>\n          <button\n            adapt-button\n            type=\"button\"\n            rx-id=\"link-account-button\"\n            btn-type=\"secondary\"\n            [disabled]=\"isAccountLinked\"\n            (click)=\"openWindow()\"\n          >\n            {{ 'com.bmc.arsys.rx.client.admin.issue-reporting-configuration.link-account.label' | translate }}\n          </button>\n        </ng-container>\n      </adapt-accordion-tab>\n\n      <button\n        adapt-button\n        type=\"button\"\n        rx-id=\"save-button\"\n        btn-type=\"primary\"\n        class=\"mt-4\"\n        [disabled]=\"issueReportingConfigurationForm.pristine || issueReportingConfigurationForm.invalid\"\n        (click)=\"saveConfig()\"\n      >\n        {{ 'com.bmc.arsys.rx.client.common.save.label' | translate }}\n      </button>\n    </form>\n  </adapt-accordion>\n</rx-admin-settings>\n"]}