{"version":3,"file":"busy.directive.js","sourceRoot":"","sources":["../../../../../libs/adapt-angular/src/busy-loader/busy.directive.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Directive,\n  Input,\n  OnDestroy,\n  ViewContainerRef,\n  ComponentFactoryResolver,\n  ComponentRef,\n  Injector,\n  OnChanges,\n  SimpleChanges,\n  ChangeDetectorRef\n} from '@angular/core';\nimport {Subscription} from 'rxjs';\n\nimport {PromiseTrackerService} from './promise-tracker.service';\nimport {AdaptBusyService} from './busy.service';\nimport {BusyConfig} from './busy-config';\nimport {AdaptBusyComponent} from './busy.component';\nimport {AdaptBusyBackdropComponent} from './busy-backdrop.component';\nimport {isString, isEqual} from 'lodash-es';\n\n/**\n * ### Syntax\n *\n * - `<div [ngBusy]=\"busy\">...</div>`\n * - `<div [ngBusy]=\"[busyA, busyB, busyC]\">...</div>`\n * - `<div [ngBusy]=\"{busy: busy, message: 'Loading...', backdrop: false, delay: 200, minDuration: 600}\">...</div>`\n */\n@Directive({\n  selector: '[adapt-busy], [ngBusy]',\n  providers: [PromiseTrackerService]\n})\nexport class AdaptBusyDirective implements OnDestroy, OnChanges {\n  /**\n   * Configuration option, see structure below\n   * @docs-default\n   */\n  @Input('ngBusy') options: BusyConfig;\n\n  @Input() adaptRadarDisableEventSending: boolean = false;\n\n  /**\n   * Alias for ngBusy.busy\n   * @since v10.2.0\n   * @docs-default\n   */\n  @Input()\n  set busyPromise(value: Promise<unknown> | Subscription | (Promise<unknown> | Subscription)[]) {\n    if (this.options) {\n      this.options.busy = value;\n    } else {\n      this.options = {busy: null};\n    }\n  }\n\n  get busyPromise(): Promise<unknown> | Subscription | (Promise<unknown> | Subscription)[] {\n    return this.options ? this.options.busy : null;\n  }\n\n  /**\n   * Set determinate mode for loaders\n   * @since v11.6.0\n   * @docs-default false\n   */\n  @Input() determinate: boolean = false;\n\n  private optionsNorm: BusyConfig;\n  private busyRef: ComponentRef<AdaptBusyComponent>;\n  private backdropRef: ComponentRef<AdaptBusyBackdropComponent>;\n\n  constructor(private service: AdaptBusyService,\n              private tracker: PromiseTrackerService,\n              private cfResolver: ComponentFactoryResolver,\n              private vcRef: ViewContainerRef,\n              private injector: Injector,\n              private changeDetectorRef: ChangeDetectorRef) {\n  }\n\n  ngOnChanges(changes: SimpleChanges): void {\n    if (changes.options || changes.busyPromise) {\n      this.updateConfig();\n    }\n\n    if (changes.determinate && this.busyRef) {\n      this.busyRef.instance.determinate = this.determinate;\n    }\n  }\n\n  ngOnDestroy(): void {\n    this.destroyComponents();\n  }\n\n  updateConfig(): void {\n    const options = this.optionsNorm = this.normalizeOptions(this.options);\n\n    if (this.busyRef) {\n      this._bindComponentProperties(options);\n    }\n\n    if (this.backdropRef) {\n      this.backdropRef.instance.type = options.loaderType;\n      this.backdropRef.instance.overlayClass = options.overlayClass;\n    }\n\n    if (!this.busyRef) {\n      this.destroyComponents();\n\n      if (options.backdrop) {\n        this.createBackdrop();\n      }\n\n      this.createBusy();\n\n      // need to manually run change detection cycle for the case\n      // when directive is initialized with already passed busy property.\n      // ngOnInit hook will be triggered only on the next change detection cycle\n      // (createComponent method only attaches newly created View to the current view and renders it)\n      // for the AdaptBusyComponent and AdaptBusyBackdropComponent,\n      // so the subscription for the activeState$ triggered by PromiseTrackerService will be missed and components will not be rendered\n      this.changeDetectorRef.detectChanges();\n    }\n\n    if (!isEqual(options.busy, this.tracker.promiseList)) {\n      this.tracker.reset({\n        promiseList: <Promise<unknown>[]>options.busy,\n        delay: isString(options.delay) ? parseInt(options.delay, 10) : options.delay,\n        minDuration: isString(options.minDuration) ? parseInt(options.minDuration, 10) : options.minDuration\n      });\n    }\n  }\n\n  private normalizeOptions(options: BusyConfig): BusyConfig {\n    if (!options) {\n      options = {busy: null};\n    } else if (Array.isArray(options)\n      || options instanceof Promise\n      || options instanceof Subscription\n    ) {\n      options = {busy: options};\n    }\n    options = Object.assign({}, this.service.config, options);\n\n    if (!Array.isArray(options.busy)) {\n      options.busy = [options.busy];\n    }\n\n    return options;\n  }\n\n  private destroyComponents(): void {\n    if (this.busyRef) {\n      this.busyRef.destroy();\n    }\n\n    if (this.backdropRef) {\n      this.backdropRef.destroy();\n    }\n  }\n\n  private createBackdrop(): void {\n    const backdropFactory = this.cfResolver.resolveComponentFactory(AdaptBusyBackdropComponent);\n    const {loaderType, overlayClass} = this.optionsNorm;\n\n    this.backdropRef = this.vcRef.createComponent(backdropFactory, null, this.injector);\n    this.backdropRef.instance.type = loaderType;\n    this.backdropRef.instance.overlayClass = overlayClass;\n  }\n\n  private createBusy(): void {\n    const busyFactory = this.cfResolver.resolveComponentFactory(AdaptBusyComponent);\n\n    this.busyRef = this.vcRef.createComponent(busyFactory, null, this.injector);\n\n    this._bindComponentProperties(this.optionsNorm);\n  }\n\n  private _bindComponentProperties(options: BusyConfig): void {\n    const {\n      message,\n      wrapperClass,\n      loaderType,\n      sticky,\n      offsetTop,\n      inOutType,\n      percentageValue,\n      loaderClass,\n      loaderImg,\n      content\n    } = options;\n    const instance = this.busyRef.instance;\n\n    instance.message = message;\n    instance.wrapperClass = wrapperClass;\n    instance.type = loaderType;\n    instance.sticky = sticky;\n    instance.offsetTop = offsetTop;\n    instance.inOutType = inOutType;\n    instance.value = percentageValue;\n    instance.determinate = this.determinate;\n    instance.loaderClass = loaderClass;\n    instance.loaderImg = loaderImg;\n    instance.content = content;\n    instance.adaptRadarDisableEventSending = this.adaptRadarDisableEventSending;\n  }\n}\n"]}