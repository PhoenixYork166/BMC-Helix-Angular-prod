{"version":3,"file":"runtime-view-canvas-item.service.js","sourceRoot":"","sources":["../../../../../../../../../../libs/platform/view/runtime/components/runtime-view-canvas/components/canvas-item/runtime-view-canvas-item.service.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ComponentFactoryResolver,\n  ComponentRef,\n  Injectable,\n  Injector,\n  OnDestroy,\n  ViewContainerRef\n} from '@angular/core';\nimport { pick } from 'lodash';\nimport { delay, distinctUntilChanged, skipWhile, takeUntil } from 'rxjs/operators';\nimport { ReplaySubject } from 'rxjs';\nimport { RuntimeViewCanvasService } from '../../component/runtime-view-canvas.service';\nimport { RuntimeLayoutItem } from '../../../../layout/runtime-layout-item.class';\nimport { RuntimeLayoutOutlet } from '../../../../layout/runtime-layout-outlet.class';\nimport { IViewComponent } from '../../../../interfaces/view-component.interface';\nimport { IChildColumn } from '../../interfaces/child-column.interface';\nimport { ComponentFactory } from '@angular/core';\n\n@Injectable()\nexport class RuntimeViewCanvasItemService implements OnDestroy {\n  container: ViewContainerRef;\n  layout: RuntimeLayoutItem;\n  componentRef: ComponentRef<any>;\n  componentInstance: IViewComponent;\n\n  hasMargin = true;\n  hasAutoFill = false;\n  hasAutoScroll = false;\n  isHidden = false;\n\n  private destroyed$ = new ReplaySubject<boolean>(1);\n\n  constructor(\n    private injector: Injector,\n    private componentFactoryResolver: ComponentFactoryResolver,\n    private runtimeViewCanvasService: RuntimeViewCanvasService\n  ) {}\n\n  ngOnDestroy(): void {\n    this.destroyed$.next(true);\n    this.destroyed$.complete();\n  }\n\n  registerOutlet(\n    outletName: string,\n    outletViewContainerRef: ViewContainerRef,\n    containerComponent?: ComponentFactory<any>\n  ): void {\n    const currentOutlet = this.layout.outlets.find((outlet) => outlet.name === outletName);\n\n    if (currentOutlet) {\n      this.renderContainerComponent(outletViewContainerRef, currentOutlet, containerComponent);\n    }\n  }\n\n  getChildren(outletName: string): IChildColumn[] {\n    const currentOutlet = this.layout.outlets.find((outlet) => outlet.name === outletName);\n\n    return currentOutlet.columns.map((column) => ({\n      ...column,\n      children: column.children\n        .filter(Boolean)\n        .map((child) => pick(child, 'config', 'guid', 'runtimeViewModelApi', 'factory', 'outlets'))\n    }));\n  }\n\n  renderViewComponent(): void {\n    this.componentRef = this.container.createComponent(this.layout.factory, null, this.injector);\n    this.componentInstance = this.componentRef.instance;\n    this.componentInstance.guid = this.layout.guid;\n    this.componentInstance.config = this.layout.config;\n    this.componentInstance.runtimeViewModelApi = this.layout.runtimeViewModelApi;\n\n    this.componentInstance.propertyChanged?.pipe(takeUntil(this.destroyed$)).subscribe((propertyChange) => {\n      this.runtimeViewCanvasService.onViewComponentPropertyChanged(propertyChange);\n    });\n\n    // Update hasMargin, hasAutoScroll, and hasAutoFill property bindings asynchronously using timeout\n    // to trigger change detection. Otherwise \"ExpressionChangedAfterItHasBeenCheckedError\" will occur.\n    this.componentInstance.hidden\n      ?.pipe(\n        skipWhile((value) => !value),\n        distinctUntilChanged(),\n        delay(0),\n        takeUntil(this.destroyed$)\n      )\n      .subscribe((hidden) => {\n        this.hasMargin = !hidden;\n        this.isHidden = hidden;\n      });\n\n    this.componentInstance.autoScroll\n      ?.pipe(\n        skipWhile((value) => !value),\n        distinctUntilChanged(),\n        delay(0),\n        takeUntil(this.destroyed$)\n      )\n      .subscribe((autoScroll) => {\n        this.hasAutoScroll = autoScroll;\n      });\n\n    this.componentInstance.autoFill\n      ?.pipe(\n        skipWhile((value) => !value),\n        distinctUntilChanged(),\n        delay(0),\n        takeUntil(this.destroyed$)\n      )\n      .subscribe((autoFill) => {\n        this.hasAutoFill = autoFill;\n      });\n  }\n\n  private renderContainerComponent(\n    outletViewContainerRef: ViewContainerRef,\n    currentOutlet: RuntimeLayoutOutlet,\n    containerComponent?: ComponentFactory<any>\n  ): void {\n    const containerComponentFactory = containerComponent;\n\n    const containerRef = outletViewContainerRef.createComponent(containerComponentFactory);\n\n    containerRef.instance.columns = currentOutlet.columns;\n    containerRef.instance.outlet = currentOutlet;\n  }\n}\n"]}