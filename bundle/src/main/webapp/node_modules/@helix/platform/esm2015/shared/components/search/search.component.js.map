{"version":3,"file":"search.component.js","sourceRoot":"","sources":["../../../../../../../libs/platform/shared/components/search/search.component.ts","../../../../../../../libs/platform/shared/components/search/search.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnDestroy, OnInit, TemplateRef, ViewChild } from '@angular/core';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { AdaptLazyLoadEvent, ColumnConfig, DataCellTemplateParams } from '@bmc-ux/adapt-table';\nimport {\n  IDataPageParams,\n  RxBundleCacheService,\n  RxDataPageFactoryService,\n  RxPageTitleService\n} from '@helix/platform/shared/api';\nimport { RxShellService } from '@helix/platform/view/api';\nimport { TranslateService } from '@ngx-translate/core';\nimport { filter, isEmpty, keyBy, map, sortBy } from 'lodash';\nimport { combineLatest, Subscription, throwError } from 'rxjs';\nimport { catchError } from 'rxjs/operators';\nimport { IRxSearchRecord } from './search-record.interface';\n\ninterface ISearchResult {\n  createDate: string;\n  modifyDate: string;\n  recordDefinitionName: string;\n  recordInstanceDisplayId: string;\n  recordInstanceId: string;\n  title: string;\n  weight: number;\n  wordsAroundHit: string;\n}\n\n@Component({\n  selector: 'rx-search',\n  templateUrl: './search.component.html',\n  styleUrls: ['./search.component.scss']\n})\nexport class RxSearchComponent implements OnDestroy, OnInit {\n  @ViewChild('colIdCellTemplate', { static: true })\n  colIdCellTemplate: TemplateRef<DataCellTemplateParams>;\n\n  @ViewChild('cellTemplate', { static: true })\n  cellTemplate: TemplateRef<DataCellTemplateParams>;\n\n  private pageSize = 50;\n  private subscription: Subscription;\n\n  loading = true;\n  loadingMore = false;\n  startIndex = 0;\n  totalSize = 0;\n\n  columns: ColumnConfig[];\n  globalSearchRecords: IRxSearchRecord[];\n  recordDefinitionsByName: { [recordDefinitioName: string]: IRxSearchRecord };\n  searchResults: ISearchResult[];\n  searchString = '';\n\n  constructor(\n    private activatedRoute: ActivatedRoute,\n    private router: Router,\n    private rxDataPageService: RxDataPageFactoryService,\n    private rxShellService: RxShellService,\n    private rxPageTitleService: RxPageTitleService,\n    private translateService: TranslateService,\n    public rxBundleCacheService: RxBundleCacheService\n  ) {}\n\n  ngOnInit(): void {\n    this.rxPageTitleService.set(this.translateService.instant('com.bmc.arsys.rx.client.shell.search.results.label'));\n\n    this.subscription = combineLatest([this.activatedRoute.queryParamMap, this.rxShellService.shellConfig$]).subscribe(\n      ([queryParams, shellConfig]) => {\n        this.searchString = queryParams.get('q') || '';\n\n        this.globalSearchRecords = map(shellConfig.globalSearchRecords, (item) => {\n          item.selected = true;\n\n          return item;\n        });\n\n        this.recordDefinitionsByName = keyBy(shellConfig.globalSearchRecords, 'name');\n\n        this.loading = false;\n\n        this.getGlobalSearchResults();\n      }\n    );\n\n    this.columns = [\n      {\n        field: 'colId',\n        width: '45px',\n        cellTemplate: this.colIdCellTemplate\n      },\n      {\n        field: 'recordDefinitionName',\n        cellTemplate: this.cellTemplate\n      }\n    ];\n  }\n\n  ngOnDestroy(): void {\n    this.subscription.unsubscribe();\n  }\n\n  get searchValue(): string {\n    return this.searchString.trim();\n  }\n\n  getGlobalSearchResults(infiniteScroll: boolean = false): void {\n    this.loading = true;\n    this.loadingMore = infiniteScroll;\n\n    if (!infiniteScroll) {\n      this.startIndex = 0;\n      this.totalSize = 0;\n    }\n\n    if (this.searchValue) {\n      const queryParams: IDataPageParams = {\n        mayHaveText: `%${this.searchValue}%`,\n        pageSize: this.pageSize,\n        searchResultOption: 'WORDS_AROUND_HIT',\n        startIndex: this.startIndex\n      };\n\n      if (!isEmpty(this.globalSearchRecords)) {\n        queryParams.recordDefinitionNames = map(filter(this.globalSearchRecords, 'selected'), 'name').join(',');\n      }\n\n      if (queryParams.recordDefinitionNames) {\n        this.rxDataPageService\n          .withType('com.bmc.arsys.rx.application.search.datapage.SearchDataPageQuery')\n          .get({ params: queryParams })\n          .pipe(\n            catchError((error) => {\n              this.loading = false;\n              this.loadingMore = false;\n\n              return throwError(error);\n            })\n          )\n          .subscribe((results) => {\n            this.loading = false;\n            this.loadingMore = false;\n\n            if (this.totalSize > 0) {\n              this.totalSize--;\n            }\n\n            this.totalSize += this.pageSize === results.totalSize ? results.totalSize + 1 : results.totalSize;\n\n            const newData = results.data as ISearchResult[];\n\n            this.startIndex += newData.length;\n\n            if (infiniteScroll) {\n              this.searchResults = this.searchResults.concat(newData);\n            } else {\n              this.searchResults = newData;\n            }\n\n            this.searchResults = sortBy(this.searchResults, 'weight');\n          });\n      } else {\n        this.resetSearchResults();\n      }\n    } else {\n      this.resetSearchResults();\n    }\n  }\n\n  private resetSearchResults() {\n    this.searchResults = [];\n    this.totalSize = 0;\n    this.loading = false;\n    this.loadingMore = false;\n  }\n\n  search(): void {\n    const trimmedSearchValue = this.searchString.trim();\n\n    if (trimmedSearchValue) {\n      this.router.navigate([], {\n        relativeTo: this.activatedRoute,\n        queryParams: { q: trimmedSearchValue },\n        queryParamsHandling: 'merge'\n      });\n    }\n  }\n\n  onFiltersChanged(): void {\n    setTimeout(() => this.getGlobalSearchResults());\n  }\n\n  onLazyLoad(event: AdaptLazyLoadEvent): void {\n    this.getGlobalSearchResults(true);\n  }\n\n  selectAllRecords(): void {\n    this.globalSearchRecords.forEach((record) => (record.selected = true));\n\n    this.getGlobalSearchResults();\n  }\n\n  unSelectAllRecords(): void {\n    this.globalSearchRecords.forEach((record) => (record.selected = false));\n\n    this.getGlobalSearchResults();\n  }\n}\n","<div class=\"row\">\n  <div class=\"col-12\">\n    <h1 class=\"mb-4 mt-0\">{{ 'com.bmc.arsys.rx.client.common.search.label' | translate }}</h1>\n  </div>\n  <div class=\"col-6 col-md-4\">\n    <form autocomplete=\"off\" (ngSubmit)=\"search()\">\n      <adapt-rx-search\n        name=\"searchString\"\n        [autofocus]=\"true\"\n        [(ngModel)]=\"searchString\"\n        [placeholder]=\"'com.bmc.arsys.rx.client.shell.searchbox.placeholder' | translate\"\n      ></adapt-rx-search>\n    </form>\n  </div>\n  <div class=\"col-1 pl-0\">\n    <div adaptDropdown>\n      <button adaptDropdownToggle class=\"btn btn-link d-icon-left-filter pl-0\">\n        {{ 'com.bmc.arsys.rx.client.common.filter-data.label' | translate }}\n      </button>\n\n      <div adaptDropdownMenu class=\"dropdown-menu p-2\">\n        <div class=\"mb-3\">{{ 'com.bmc.arsys.rx.client.common.record-definition.label' | translate }}</div>\n\n        <div class=\"d-flex justify-content-between\">\n          <button\n            adapt-button\n            btn-type=\"tertiary\"\n            type=\"button\"\n            rx-id=\"select-all-button\"\n            class=\"btn btn-link p-0\"\n            (click)=\"selectAllRecords()\"\n          >\n            {{ 'com.bmc.arsys.rx.client.common.select-all.label' | translate }}\n          </button>\n\n          <button\n            adapt-button\n            btn-type=\"tertiary\"\n            type=\"button\"\n            rx-id=\"select-none-button\"\n            class=\"btn btn-link p-0\"\n            (click)=\"unSelectAllRecords()\"\n          >\n            {{ 'com.bmc.arsys.rx.client.common.select-none.label' | translate }}\n          </button>\n        </div>\n\n        <ul *ngIf=\"globalSearchRecords\" class=\"list-unstyled mb-0\">\n          <li *ngFor=\"let record of globalSearchRecords\">\n            <adapt-rx-checkbox\n              class=\"mb-0 mt-3\"\n              [label]=\"record.name | rxDefinitionNamePipe\"\n              [(ngModel)]=\"record.selected\"\n              (change)=\"onFiltersChanged()\"\n            ></adapt-rx-checkbox>\n          </li>\n        </ul>\n      </div>\n    </div>\n  </div>\n</div>\n\n<div *ngIf=\"searchValue && (searchResults?.length || loading)\" class=\"row table-wrapper mt-1\">\n  <div class=\"col-12\">\n    <adapt-table\n      scrollHeight=\"flex\"\n      [value]=\"searchResults\"\n      [columns]=\"columns\"\n      [totalRecords]=\"totalSize\"\n      [rows]=\"searchResults?.length\"\n      [first]=\"startIndex\"\n      [paginator]=\"false\"\n      [scrollable]=\"true\"\n      (onLazyLoad)=\"onLazyLoad($event)\"\n      [lazy]=\"true\"\n      [lazyLoadOnInit]=\"false\"\n      [loading]=\"loading\"\n      [loadingMore]=\"loadingMore\"\n      [enableInfiniteScrolling]=\"true\"\n    >\n    </adapt-table>\n  </div>\n</div>\n\n<ng-template #colIdCellTemplate let-rowIndex=\"rowIndex\">\n  {{ rowIndex + 1 }}\n</ng-template>\n\n<ng-template #cellTemplate let-searchResult=\"dataItem\">\n  <div>\n    <span\n      >{{ searchResult.recordDefinitionName | rxDefinitionNamePipe }}\n      <a\n        [routerLink]=\"[\n          '/',\n          this.rxBundleCacheService.bundleId,\n          'view',\n          recordDefinitionsByName[searchResult.recordDefinitionName].view\n        ]\"\n        [queryParams]=\"{ $0$: searchResult.recordInstanceId }\"\n        >{{ searchResult.recordInstanceDisplayId }}</a\n      ></span\n    >\n  </div>\n  <div>\n    <span>{{ searchResult.title }}</span>\n  </div>\n\n  <adapt-highlight class=\"search-result\" [result]=\"searchResult.wordsAroundHit\" [term]=\"searchValue\"></adapt-highlight>\n</ng-template>\n"]}