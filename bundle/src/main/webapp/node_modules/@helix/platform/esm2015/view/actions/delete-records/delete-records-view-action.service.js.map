{"version":3,"file":"delete-records-view-action.service.js","sourceRoot":"","sources":["../../../../../../../libs/platform/view/actions/delete-records/delete-records-view-action.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\nimport { TranslateService } from '@ngx-translate/core';\nimport { RX_MODAL, RxModalService } from '@helix/platform/ui-kit';\nimport { IRxRecordGridApi, IViewActionService, RxViewActionUtilsService } from '@helix/platform/view/api';\nimport { RxRecordInstanceService } from '@helix/platform/record/api';\nimport { RxLogService, RxNotificationService } from '@helix/platform/shared/api';\nimport { EMPTY, forkJoin, from, Observable, throwError } from 'rxjs';\nimport { IDeleteRecordsViewActionParams } from './delete-records-view-action-params.interface';\nimport { switchMap, switchMapTo, tap } from 'rxjs/operators';\nimport { RxError, RxStringService } from '@helix/platform/utils';\nimport { castArray, isEmpty, isFunction } from 'lodash';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class RxDeleteRecordsViewActionService implements IViewActionService<IDeleteRecordsViewActionParams, never> {\n  constructor(\n    private rxLogService: RxLogService,\n    private rxModalService: RxModalService,\n    private translateService: TranslateService,\n    private rxNotificationService: RxNotificationService,\n    private rxRecordInstanceService: RxRecordInstanceService,\n    private rxViewActionUtilsService: RxViewActionUtilsService,\n    private rxStringService: RxStringService\n  ) {}\n\n  execute(params: IDeleteRecordsViewActionParams): Observable<never> {\n    if (\n      isEmpty(params.recordDefinitionName) &&\n      params.records &&\n      isFunction((<IRxRecordGridApi>params.records).getRecordDefinitionName)\n    ) {\n      params.recordDefinitionName = (<IRxRecordGridApi>params.records).getRecordDefinitionName();\n    }\n\n    if (this.rxStringService.isNonEmptyString(params.recordDefinitionName)) {\n      let records = [];\n\n      if (params.records) {\n        if (isFunction((<IRxRecordGridApi>params.records).getSelectedRows)) {\n          records = castArray((<IRxRecordGridApi>params.records).getSelectedRows());\n        } else {\n          records = castArray(<IRxRecordGridApi>params.records);\n        }\n      }\n\n      const recordIds = this.rxViewActionUtilsService.extractRecordIds(records);\n\n      if (recordIds.length) {\n        const message =\n          recordIds.length === 1\n            ? 'com.bmc.arsys.rx.client.view-actions.delete-record.confirmation-dialog.message'\n            : 'com.bmc.arsys.rx.client.view-actions.delete-records.confirmation-dialog.message';\n\n        return from(\n          this.rxModalService.confirm({\n            title: this.translateService.instant('com.bmc.arsys.rx.client.common.warning.label'),\n            modalStyle: RX_MODAL.modalStyles.warning,\n            message: this.translateService.instant(message, { count: recordIds.length })\n          })\n        ).pipe(\n          switchMap((res) => {\n            if (res) {\n              const deleteObservables = recordIds.map((recordId) =>\n                this.rxRecordInstanceService.delete(params.recordDefinitionName, recordId)\n              );\n\n              return forkJoin(deleteObservables).pipe(\n                tap(() => {\n                  this.rxNotificationService.addSuccessMessage(\n                    this.translateService.instant(\n                      'com.bmc.arsys.rx.client.view-actions.delete-records.records-deleted.message'\n                    )\n                  );\n                }),\n                switchMapTo(\n                  isFunction((<IRxRecordGridApi>params.records).refresh)\n                    ? (<IRxRecordGridApi>params.records).refresh()\n                    : EMPTY\n                )\n              );\n            } else {\n              return throwError(null);\n            }\n          })\n        );\n      } else {\n        this.rxLogService.debug('rxDeleteRecordsAction: no records to delete.');\n\n        return EMPTY;\n      }\n    } else {\n      return throwError(new RxError('rxDeleteRecordsAction: Record Definition Name is not defined.'));\n    }\n  }\n}\n"]}