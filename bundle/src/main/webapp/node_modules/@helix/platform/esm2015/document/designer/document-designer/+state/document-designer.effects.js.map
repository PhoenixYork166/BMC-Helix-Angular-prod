{"version":3,"file":"document-designer.effects.js","sourceRoot":"","sources":["../../../../../../../../libs/platform/document/designer/document-designer/+state/document-designer.effects.ts"],"names":[],"mappings":"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","sourcesContent":["import { HttpResponse } from '@angular/common/http';\nimport { ErrorHandler, Injectable } from '@angular/core';\nimport { IDocumentDefinition, RxDocumentDefinitionService } from '@helix/platform/document/api';\nimport { RxDefinitionNameService, RxDefinitionUpdateService, RxNotificationService } from '@helix/platform/shared/api';\nimport { Actions, createEffect, ofType } from '@ngrx/effects';\nimport { Store } from '@ngrx/store';\nimport { TranslateService } from '@ngx-translate/core';\nimport { last } from 'lodash';\nimport { of } from 'rxjs';\nimport { catchError, filter, map, switchMap, tap, withLatestFrom } from 'rxjs/operators';\nimport { DocumentDesignerService } from '../../document-designer.service';\nimport * as DocumentDesignerActions from './document-designer.actions';\nimport {\n  bundleIdSelector,\n  definitionModelSelector,\n  definitionNameSelector,\n  originalDefinitionSelector\n} from './document-designer.selectors';\n\n@Injectable()\nexport class DocumentDesignerEffects {\n  constructor(\n    private store$: Store<any>,\n    private actions$: Actions,\n    private errorHandler: ErrorHandler,\n    private rxDefinitionUpdateService: RxDefinitionUpdateService,\n    private documentDesignerService: DocumentDesignerService,\n    private rxNotificationService: RxNotificationService,\n    private translateService: TranslateService,\n    private rxDocumentDefinitionService: RxDocumentDefinitionService,\n    private rxDefinitionNameService: RxDefinitionNameService\n  ) {}\n\n  initDocumentDesigner$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.init),\n      map((action) => DocumentDesignerActions.loadDefinition())\n    )\n  );\n\n  loadDefinition$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.loadDefinition),\n      withLatestFrom(this.store$.select(definitionNameSelector)),\n      switchMap(([action, definitionName]) =>\n        definitionName\n          ? this.rxDocumentDefinitionService.get(definitionName)\n          : this.rxDocumentDefinitionService.getNew()\n      ),\n      map((definition: IDocumentDefinition) =>\n        DocumentDesignerActions.loadDefinitionSuccess({\n          definition\n        })\n      )\n    )\n  );\n\n  loadDefinitionSuccess$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.loadDefinitionSuccess),\n      map((action) => {\n        let definitionModelFromDefinition = {\n          customizationOptions: {\n            scope: action.definition.scope,\n            allowOverlay: action.definition.allowOverlay\n          },\n          description: action.definition.description,\n          documentSchema: action.definition.documentSchema,\n          guid: action.definition.guid,\n          lastChangedBy: action.definition.lastChangedBy,\n          lastUpdateTime: action.definition.lastUpdateTime,\n          name: this.rxDefinitionNameService.getDisplayName(action.definition.name),\n          overlayDescriptor: action.definition.overlayDescriptor,\n          overlayGroupId: action.definition.overlayGroupId,\n          owner: action.definition.owner\n        };\n\n        return DocumentDesignerActions.initDefinitionData({\n          definition: action.definition,\n          definitionModel: definitionModelFromDefinition\n        });\n      })\n    )\n  );\n\n  revertCustomization$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.revertCustomization),\n      withLatestFrom(this.store$.select(definitionModelSelector), this.store$.select(bundleIdSelector)),\n      switchMap(([_, definitionModel, bundleId]) =>\n        this.rxDocumentDefinitionService.revertCustomization(`${bundleId}:${definitionModel.name}`)\n      ),\n      map(() => DocumentDesignerActions.loadDefinition())\n    )\n  );\n\n  markPristine$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.initDefinitionData, DocumentDesignerActions.saveDefinition),\n      map(() => DocumentDesignerActions.markDesignerPristine())\n    )\n  );\n\n  markDirty$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.updateDefinitionModelFromDesigner, DocumentDesignerActions.saveDefinitionError),\n      map(() => DocumentDesignerActions.markDesignerDirty())\n    )\n  );\n\n  saveDefinition$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.saveDefinition),\n      withLatestFrom(\n        this.store$.select(definitionModelSelector),\n        this.store$.select(originalDefinitionSelector),\n        this.store$.select(bundleIdSelector)\n      ),\n      switchMap(([_, definitionModel, originalDefinition, bundleId]) => {\n        const definition = this.documentDesignerService.getDefinitionFromDefinitionModel(definitionModel, bundleId);\n\n        return (\n          definition.lastUpdateTime\n            ? this.rxDefinitionUpdateService.execute(\n                this.rxDocumentDefinitionService.update.bind(this.rxDocumentDefinitionService, {\n                  ...originalDefinition,\n                  ...definition\n                })\n              )\n            : this.rxDocumentDefinitionService.create(definition)\n        ).pipe(\n          map((response: HttpResponse<any>) => {\n            const definitionName =\n              decodeURIComponent(last(response?.headers.get('location').split('/')) || '') ||\n              this.rxDefinitionNameService.getDefinitionName(bundleId, definitionModel.name);\n\n            return DocumentDesignerActions.saveDefinitionSuccess({\n              savedDefinitionName: definitionName\n            });\n          }),\n          catchError((error) => {\n            this.errorHandler.handleError(error);\n\n            return of(DocumentDesignerActions.saveDefinitionError());\n          })\n        );\n      })\n    )\n  );\n\n  saveDefinitionSuccess$ = createEffect(() =>\n    this.actions$.pipe(\n      ofType(DocumentDesignerActions.saveDefinitionSuccess),\n      withLatestFrom(this.store$.select(definitionNameSelector)),\n      tap(() => {\n        this.rxNotificationService.addSuccessMessage(\n          this.translateService.instant('com.bmc.arsys.rx.client.designer.definition-saved-successfully.message', {\n            definitionTypeDisplayName: this.translateService.instant(\n              'com.bmc.arsys.rx.client.document-definition.label'\n            )\n          })\n        );\n      }),\n      filter(([action, definitionName]) => !!definitionName),\n      map(() => DocumentDesignerActions.loadDefinition())\n    )\n  );\n}\n"]}