{"version":3,"file":"download-report-modal.component.js","sourceRoot":"","sources":["../../../../../../../../../libs/platform/admin/components/cognitive-consumption/components/download-report-modal/download-report-modal.component.ts","../../../../../../../../../libs/platform/admin/components/cognitive-consumption/components/download-report-modal/download-report-modal.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, OnInit } from '@angular/core';\nimport { filter, find, forEach, head, includes, last, map, parseInt, some } from 'lodash';\nimport { forkJoin } from 'rxjs';\nimport moment from 'moment-es6';\nimport { ActiveModalRef, RxDatetimePickerMode, RxDatetimeStruct } from '@bmc-ux/adapt-angular';\nimport { IPlainObject } from '@helix/platform/shared/api';\nimport { RX_COGNITIVE_CONSUMPTION } from '../../cognitive-consumption.constant';\nimport { RxCognitiveConsumptionService } from '../../cognitive-consumption.service';\nimport { CsvData, RX_SIZE_UNITS, RxCsvService, RxFileService, RxUnitService } from '@helix/platform/utils';\nimport {\n  ICognitiveConsumptionGroup,\n  ICognitiveConsumptionSection,\n  ICognitiveLicenseUsage,\n  ICognitiveLicenseUsageParams\n} from '../../cognitive-consumption.types';\nimport { TranslateService } from '@ngx-translate/core';\n\n@Component({\n  selector: 'rx-download-report-modal',\n  templateUrl: './download-report-modal.component.html'\n})\nexport class DownloadReportModalComponent implements OnInit {\n  customRange: RxDatetimeStruct[];\n  modalData: IPlainObject;\n  period: string;\n\n  dateTimePickerMode = RxDatetimePickerMode.DateTime;\n\n  parameters: ICognitiveLicenseUsageParams = {\n    startDate: '',\n    endDate: '',\n    countType: RX_COGNITIVE_CONSUMPTION.settings.countType\n  };\n\n  periodOptions = [\n    {\n      label: this.translateService.instant(\n        'com.bmc.arsys.rx.client.admin.cognitive-consumption.download-report-modal.last-twelve-months.label'\n      ),\n      value: '12'\n    },\n    {\n      label: this.translateService.instant(\n        'com.bmc.arsys.rx.client.admin.cognitive-consumption.download-report-modal.last-twenty-four-months.label'\n      ),\n      value: '24'\n    },\n    {\n      label: this.translateService.instant(\n        'com.bmc.arsys.rx.client.admin.cognitive-consumption.download-report-modal.last-thirty-six-months.label'\n      ),\n      value: '36'\n    },\n    {\n      label: this.translateService.instant(\n        'com.bmc.arsys.rx.client.admin.cognitive-consumption.download-report-modal.selected-time-period.label'\n      ),\n      value: 'custom'\n    }\n  ];\n\n  csvData: CsvData = [['Operation', 'Application', 'Period', 'Count']];\n\n  constructor(\n    private activeModalRef: ActiveModalRef,\n    private rxCognitiveConsumptionService: RxCognitiveConsumptionService,\n    private rxCsvService: RxCsvService,\n    private rxFileService: RxFileService,\n    private rxUnitService: RxUnitService,\n    public translateService: TranslateService\n  ) {\n    this.modalData = this.activeModalRef.getData();\n  }\n\n  ngOnInit(): void {\n    this.period = head(this.periodOptions).value;\n  }\n\n  onDownloadClick(): void {\n    if (this.period === 'custom') {\n      this.parameters.endDate = moment(last(this.customRange)).format('YYYY-MM');\n      this.parameters.startDate = moment(head(this.customRange)).format('YYYY-MM');\n    } else {\n      this.parameters.endDate = moment().format('YYYY-MM');\n\n      this.parameters.startDate = moment(this.parameters.endDate, 'YYYY-MM')\n        .add(-1 * parseInt(this.period, 10), 'months')\n        .format('YYYY-MM');\n    }\n\n    const sections: ICognitiveConsumptionSection[] = filter(RX_COGNITIVE_CONSUMPTION.sections, (section) =>\n      includes(this.modalData.sectionIds, section.id)\n    );\n\n    const groupIds: string[] = [];\n\n    forEach(sections, (section) => {\n      forEach(section.groups, (group) => {\n        groupIds.push(group.id);\n      });\n    });\n\n    forkJoin(\n      map(groupIds, (groupId) => {\n        return this.rxCognitiveConsumptionService.getCognitiveLicenseUsage(\n          RX_COGNITIVE_CONSUMPTION.settings.licenseType,\n          groupId,\n          this.parameters\n        );\n      })\n    ).subscribe((licenseUsages: ICognitiveLicenseUsage[]) => {\n      forEach(licenseUsages, (licenseUsage) => {\n        const currentSection: ICognitiveConsumptionSection = find(sections, (section) =>\n          some(section.groups, ['id', licenseUsage.operation])\n        );\n\n        const group: ICognitiveConsumptionGroup = find(currentSection.groups, ['id', licenseUsage.operation]);\n\n        forEach(licenseUsage.licenseUsageCount, (licenseUsageCount) => {\n          forEach(licenseUsageCount.count, (value, period) => {\n            this.csvData.push([\n              `${this.translateService.instant(currentSection.title)} - ${this.translateService.instant(\n                head(group.charts).title\n              )}`,\n              licenseUsageCount.bundleId,\n              period,\n              group.unit === RX_SIZE_UNITS.gigabytes.unit ? this.rxUnitService.getValueWithUnits(value) : value\n            ]);\n          });\n        });\n      });\n\n      const csv: string = this.rxCsvService.convertToCsv(this.csvData);\n\n      this.rxFileService.createAndDownloadBlob(csv, 'text/csv;charset=utf-8;', 'report', 'csv');\n      this.activeModalRef.close();\n    });\n  }\n\n  onCancelClick(): void {\n    this.activeModalRef.dismiss();\n  }\n}\n","<div class=\"modal-body\">\n  <form>\n    <adapt-rx-radiobutton-group name=\"period\" [(ngModel)]=\"period\">\n      <adapt-rx-radiobutton\n        *ngFor=\"let option of periodOptions\"\n        [label]=\"option.label | translate\"\n        [value]=\"option.value\"\n      ></adapt-rx-radiobutton>\n    </adapt-rx-radiobutton-group>\n\n    <adapt-rx-datetime-range\n      name=\"customDatetimeRange\"\n      label=\" {{\n        'com.bmc.arsys.rx.client.admin.cognitive-consumption.download-report-modal.select-range.label' | translate\n      }}\"\n      [mode]=\"dateTimePickerMode\"\n      [disabled]=\"period !== 'custom'\"\n      [(ngModel)]=\"customRange\"\n    ></adapt-rx-datetime-range>\n  </form>\n</div>\n\n<div class=\"modal-footer\">\n  <button\n    rx-id=\"download-button\"\n    adapt-button\n    btn-type=\"primary\"\n    type=\"button\"\n    (click)=\"onDownloadClick()\"\n  >\n    {{ 'com.bmc.arsys.rx.client.common.download.label' | translate }}\n  </button>\n\n  <button rx-id=\"cancel-button\" adapt-button btn-type=\"secondary\" type=\"button\" (click)=\"onCancelClick()\">\n    {{ 'com.bmc.arsys.rx.client.common.cancel.label' | translate }}\n  </button>\n</div>\n"]}