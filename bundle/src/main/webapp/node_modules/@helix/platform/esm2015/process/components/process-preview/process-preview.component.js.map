{"version":3,"file":"process-preview.component.js","sourceRoot":"","sources":["../../../../../../../libs/platform/process/components/process-preview/process-preview.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, ElementRef, Input, OnDestroy, OnInit } from '@angular/core';\nimport { isEqual } from 'lodash';\nimport { Observable, ReplaySubject } from 'rxjs';\nimport { distinctUntilChanged, filter, shareReplay, switchMap, takeUntil, tap } from 'rxjs/operators';\nimport {\n  IProcessDefinition,\n  RX_PROCESS_DEFINITION,\n  RxProcessDefinitionCacheService,\n  RxProcessElementSearchService\n} from '@helix/platform/process/api';\nimport { RxProcessElementService, RxRappidPaperService } from '@helix/platform/process/elements';\n\ndeclare var joint: any;\n\nexport interface IProcessDesignerConfiguration {\n  processDefinitionName?: string;\n  zoomToFit?: boolean;\n  onClick?: ({ processDefinition: IProcessDefinition, cellView: {} }) => void;\n}\n\n@Component({\n  selector: 'rx-process-preview',\n  template: '',\n  styleUrls: ['./process-preview.component.scss']\n})\nexport class RxProcessPreviewComponent implements OnDestroy, OnInit {\n  @Input()\n  config: Observable<IProcessDesignerConfiguration>;\n\n  onClick: ({ processDefinition: IProcessDefinition, cellView: {} }) => void;\n  processDefinitionName: string;\n  zoomToFit = false;\n\n  processDefinition: IProcessDefinition;\n\n  private destroyed$ = new ReplaySubject<boolean>(1);\n  private paperScroller;\n\n  constructor(\n    private element: ElementRef,\n    private rxProcessDefinitionCacheService: RxProcessDefinitionCacheService,\n    private rxProcessElementService: RxProcessElementService,\n    private rxProcessElementSearchService: RxProcessElementSearchService,\n    private rxRappidPaperService: RxRappidPaperService\n  ) {\n    this.rxProcessDefinitionCacheService.registerConsumer(this.destroyed$);\n  }\n\n  ngOnInit() {\n    const config$ = this.config.pipe(\n      distinctUntilChanged(isEqual),\n      filter((config) => config.processDefinitionName),\n      tap((config) => {\n        this.onClick = config.onClick;\n        this.processDefinitionName = config.processDefinitionName;\n        this.zoomToFit = config.zoomToFit;\n      }),\n      switchMap((config) => {\n        return this.rxProcessDefinitionCacheService.getProcessDefinition(config.processDefinitionName).pipe(\n          tap((processDefinition) => {\n            this.processDefinition = processDefinition;\n          })\n        );\n      }),\n      shareReplay(1)\n    );\n\n    config$\n      .pipe(\n        tap(() => this.initialize()),\n        takeUntil(this.destroyed$)\n      )\n      .subscribe();\n  }\n\n  ngOnDestroy(): void {\n    this.destroyed$.next(true);\n    this.destroyed$.complete();\n  }\n\n  initialize() {\n    let graph;\n\n    if (this.processDefinition.layout) {\n      graph = this.rxProcessElementService.getGraph(this.processDefinition);\n    } else {\n      graph = this.getGraph(this.processDefinition);\n    }\n\n    this.paperScroller = this.rxRappidPaperService.init(this.element.nativeElement, graph, this.zoomToFit);\n\n    if (this.onClick) {\n      this.paperScroller.options.paper.on('blank:pointerdown', () => {\n        this.onClick({\n          processDefinition: this.processDefinition,\n          cellView: null\n        });\n      });\n\n      this.paperScroller.options.paper.on('cell:pointerup', (cellView) => {\n        this.onClick({\n          processDefinition: this.processDefinition,\n          cellView: cellView\n        });\n      });\n    }\n  }\n\n  zoomIn(): void {\n    this.paperScroller.zoom(0.2, { max: 4 });\n  }\n\n  zoomOut(): void {\n    this.paperScroller.zoom(-0.2, { min: 0.2 });\n  }\n\n  private getGraph(processDefinition: IProcessDefinition) {\n    const actionsLength = this.rxProcessElementSearchService.filter(processDefinition, (element) => {\n      return (\n        element.resourceType === RX_PROCESS_DEFINITION.processElementResourceTypes.processAction ||\n        element.resourceType === RX_PROCESS_DEFINITION.processElementResourceTypes.userTask ||\n        element.resourceType === RX_PROCESS_DEFINITION.processElementResourceTypes.receiveTask ||\n        element.resourceType === RX_PROCESS_DEFINITION.processElementResourceTypes.callActivity\n      );\n    }).length;\n\n    const start = new joint.shapes.bpmn.Event({\n      size: {\n        width: 50,\n        height: 50\n      },\n      attrs: {\n        '.label': {\n          fill: 'gray',\n          text: 'Start'\n        }\n      },\n      eventType: 'start',\n      position: {\n        x: 50,\n        y: 50\n      }\n    });\n\n    const startCount = new joint.shapes.basic.Rect({\n      size: {\n        width: 30,\n        height: 30\n      },\n      attrs: {\n        text: {\n          text: processDefinition.inputParams.length || 0\n        },\n        g: {\n          'stroke-opacity': 0\n        }\n      },\n      position: {\n        x: 60,\n        y: 60\n      }\n    });\n\n    const actionLabel = new joint.shapes.basic.Rect({\n      size: {\n        width: 30,\n        height: 30\n      },\n      attrs: {\n        text: {\n          text: 'Actions',\n          fill: 'gray'\n        },\n        g: {\n          'stroke-opacity': 0\n        }\n      },\n      position: {\n        x: 235,\n        y: 110\n      }\n    });\n\n    const endCount = new joint.shapes.basic.Rect({\n      size: {\n        width: 30,\n        height: 30\n      },\n      attrs: {\n        text: {\n          text: '1'\n        },\n        g: {\n          'stroke-opacity': 0\n        }\n      },\n      position: {\n        x: 410,\n        y: 60\n      }\n    });\n\n    const end = new joint.shapes.bpmn.Event({\n      size: {\n        width: 50,\n        height: 50\n      },\n      attrs: {\n        '.label': {\n          fill: 'gray',\n          text: RX_PROCESS_DEFINITION.processElementDisplayNames.endEvent\n        }\n      },\n      eventType: 'end',\n      position: {\n        x: 400,\n        y: 50\n      }\n    });\n\n    const action = new joint.shapes.basic.Rect({\n      size: {\n        width: 200,\n        height: 50\n      },\n      attrs: {\n        text: {\n          text: String(actionsLength)\n        }\n      },\n      position: {\n        x: 150,\n        y: 50\n      },\n      eventType: 'start'\n    });\n\n    const startActionLink = new joint.shapes.bpmn.Flow({\n      source: {\n        x: 100,\n        y: 75\n      },\n      target: {\n        id: action.id\n      }\n    });\n\n    const actionEndLink = new joint.shapes.bpmn.Flow({\n      source: {\n        id: action.id\n      },\n      target: {\n        x: 400,\n        y: 75\n      }\n    });\n\n    const graph = new joint.dia.Graph();\n\n    graph.addCells([start, end, action, startActionLink, actionEndLink, startCount, endCount, actionLabel]);\n\n    return graph.toJSON();\n  }\n}\n"]}