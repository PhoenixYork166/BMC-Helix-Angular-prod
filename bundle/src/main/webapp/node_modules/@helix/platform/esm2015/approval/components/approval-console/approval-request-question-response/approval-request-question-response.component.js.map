{"version":3,"file":"approval-request-question-response.component.js","sourceRoot":"","sources":["../../../../../../../../libs/platform/approval/components/approval-console/approval-request-question-response/approval-request-question-response.component.ts","../../../../../../../../libs/platform/approval/components/approval-console/approval-request-question-response/approval-request-question-response.component.html"],"names":[],"mappings":"AAAA,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAU,MAAM,eAAe,CAAC;AAC5D,OAAO,EAAE,cAAc,EAAE,cAAc,EAA2B,MAAM,uBAAuB,CAAC;AAEhG,OAAO,EAAE,mBAAmB,EAAE,MAAM,8BAA8B,CAAC;AACnE,OAAO,EAAkB,oBAAoB,EAAE,uBAAuB,EAAE,MAAM,4BAA4B,CAAC;AAC3G,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG,EAAE,MAAM,gBAAgB,CAAC;AAC1D,OAAO,EAAE,qBAAqB,EAAE,MAAM,4BAA4B,CAAC;AACnE,OAAO,EAAE,gBAAgB,EAAE,MAAM,qBAAqB,CAAC;AACvD,OAAO,EAAE,wBAAwB,EAAE,MAAM,6BAA6B,CAAC;AACvE,OAAO,EAAE,EAAE,EAAE,MAAM,MAAM,CAAC;AAC1B,OAAO,EAAE,YAAY,EAAE,MAAM,wBAAwB,CAAC;;;;;;;;;AAOtD,MAAM,OAAO,wCAAyC,SAAQ,YAAY;IASxE,YACU,cAA8B,EAC9B,uBAAgD,EAChD,qBAA4C,EAC5C,gBAAkC,EAClC,wBAAkD,EAChD,QAAkB;QAE5B,KAAK,CAAC,cAAc,EAAE,QAAQ,CAAC,CAAC;QAPxB,mBAAc,GAAd,cAAc,CAAgB;QAC9B,4BAAuB,GAAvB,uBAAuB,CAAyB;QAChD,0BAAqB,GAArB,qBAAqB,CAAuB;QAC5C,qBAAgB,GAAhB,gBAAgB,CAAkB;QAClC,6BAAwB,GAAxB,wBAAwB,CAA0B;QAChD,aAAQ,GAAR,QAAQ,CAAU;QAd9B,YAAO,GAAmB,IAAI,CAAC,cAAc,CAAC,OAAO,EAAE,CAAC,eAAwC,CAAC;QACjG,eAAU,GAAc,EAAE,CAAC;QAE3B,yBAAoB,GAAG,IAAI,CAAC;QAG5B,2BAAsB,GAAW,IAAI,CAAC,OAAO,CAAC,mBAAmB,CAAC,yBAAyB,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;QAiF/G,uBAAkB,GAAG,GAAG,EAAE;YACxB,IAAI,CAAC,uBAAuB,CAAC,kBAAkB,CAC7C,mBAAmB,CAAC,yBAAyB,CAAC,UAAU,EACxD,MAAM,CAAC,mBAAmB,CAAC,yBAAyB,CAAC,MAAM,CAAC,UAAU,CAAC,EACvE,IAAI,CAAC,OAAO,CAAC,oBAAoB,CAAC,YAAY,CAAC,EAAE,CAAC,EAClD,IAAI,CAAC,OAAO,CAAC,mBAAmB,CAAC,yBAAyB,CAAC,MAAM,CAAC,UAAU,CAAC,CAC9E,CAAC;QACJ,CAAC,CAAC;IA7EF,CAAC;IAED,OAAO;QACL,OAAO,CAAC,IAAI,CAAC,oBAAoB,EAAE,CAAC;IACtC,CAAC;IAED,QAAQ;QACN,KAAK,CAAC,QAAQ,EAAE,CAAC;QAEjB,IAAI,IAAI,CAAC,sBAAsB,EAAE;YAC/B,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,eAAe,EAAE,CAAC;SAC1C;IACH,CAAC;IAED,YAAY;QACV,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAE1B,IAAI,CAAC,uBAAuB;aACzB,GAAG,CAAC,mBAAmB,CAAC,yBAAyB,CAAC,UAAU,EAAE,IAAI,CAAC,OAAO,CAAC,oBAAoB,CAAC,YAAY,CAAC,EAAE,CAAC,CAAC;aACjH,IAAI,CACH,SAAS,CAAC,CAAC,cAA8B,EAAE,EAAE;YAC3C,cAAc,CAAC,aAAa,CAC1B,MAAM,CAAC,mBAAmB,CAAC,yBAAyB,CAAC,MAAM,CAAC,QAAQ,CAAC,EACrE,IAAI,CAAC,QAAQ,CACd,CAAC;YAEF,OAAO,IAAI,CAAC,uBAAuB,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC;QAC3D,CAAC,CAAC,EACF,GAAG,CAAC,GAAG,EAAE;YACP,IAAI,CAAC,qBAAqB,CAAC,iBAAiB,CAC1C,IAAI,CAAC,gBAAgB,CAAC,OAAO,CAC3B,0FAA0F,CAC3F,CACF,CAAC;QACJ,CAAC,CAAC,EACF,SAAS,CAAC,GAAG,EAAE;YACb,IAAI,IAAI,CAAC,oBAAoB,EAAE;gBAC7B,MAAM,sBAAsB,GAAG,IAAI,QAAQ,EAAE,CAAC;gBAE9C,sBAAsB,CAAC,MAAM,CAC3B,mBAAmB,CAAC,yBAAyB,CAAC,MAAM,CAAC,UAAU,EAC/D,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,IAAI,EACvB,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAC7B,CAAC;gBAEF,OAAO,IAAI,CAAC,wBAAwB,CAAC,cAAc,CACjD,sBAAsB,EACtB,IAAI,CAAC,OAAO,CAAC,oBAAoB,CAAC,YAAY,CAAC,EAAE,CAAC,CACnD,CAAC;aACH;iBAAM;gBACL,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC;aACjB;QACH,CAAC,CAAC,EACF,QAAQ,CAAC,GAAG,EAAE;YACZ,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QAC3B,CAAC,CAAC,CACH;aACA,SAAS,CAAC,GAAG,EAAE;YACd,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QAClC,CAAC,CAAC,CAAC;IACP,CAAC;IAED,sBAAsB;QACpB,IAAI,CAAC,oBAAoB,GAAG,KAAK,CAAC;IACpC,CAAC;IAED,iBAAiB;QACf,IAAI,CAAC,oBAAoB,GAAG,IAAI,CAAC;IACnC,CAAC;IAWD,MAAM;QACJ,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,cAAc,CAAC,SAAS,CAAC,CAAC;IACxD,CAAC;IAEO,eAAe;QACrB,OAAO;YACL;gBACE,IAAI,EAAE,IAAI,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,sBAAsB,CAAC;gBAC/C,WAAW,EAAE,KAAK;gBAClB,UAAU,EAAE,KAAK;gBACjB,QAAQ,EAAE,GAAG;gBACb,KAAK,EAAE,KAAK;gBACZ,SAAS,EAAE,EAAE;gBACb,aAAa,EAAE,IAAI;aACpB;SACF,CAAC;IACJ,CAAC;IAED,oBAAoB;;QAClB,OAAO,CAAC,IAAI,CAAC,YAAY,IAAI,CAAC,IAAI,CAAC,QAAQ,IAAI,CAAC,IAAI,CAAC,sBAAsB,IAAI,CAAC,CAAA,MAAA,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,0CAAE,IAAI,CAAA,CAAC,CAAC;IAC5G,CAAC;;qIArHU,wCAAwC;yHAAxC,wCAAwC,oGCjBrD,0rEA4EA;2FD3Da,wCAAwC;kBALpD,SAAS;mBAAC;oBACT,QAAQ,EAAE,uCAAuC;oBACjD,WAAW,EAAE,qDAAqD;oBAClE,SAAS,EAAE,CAAC,qDAAqD,CAAC;iBACnE","sourcesContent":["import { Component, Injector, OnInit } from '@angular/core';\nimport { ActiveModalRef, DismissReasons, FileObj, KeyValueObject } from '@bmc-ux/adapt-angular';\nimport { INeedAttentionRequest } from '../approval-console.types';\nimport { RX_APPROVAL_CONSOLE } from '../approval-console.constant';\nimport { RecordInstance, RX_RECORD_DEFINITION, RxRecordInstanceService } from '@helix/platform/record/api';\nimport { finalize, switchMap, tap } from 'rxjs/operators';\nimport { RxNotificationService } from '@helix/platform/shared/api';\nimport { TranslateService } from '@ngx-translate/core';\nimport { RxApprovalConsoleService } from '../approval-console.service';\nimport { of } from 'rxjs';\nimport { RxModalClass } from '@helix/platform/ui-kit';\n\n@Component({\n  selector: 'rx-approval-request-question-response',\n  templateUrl: './approval-request-question-response.component.html',\n  styleUrls: ['./approval-request-question-response.component.scss']\n})\nexport class ApprovalRequestQuestionResponseComponent extends RxModalClass implements OnInit {\n  request: KeyValueObject = this.activeModalRef.getData().selectedRequest as INeedAttentionRequest;\n  attachment: FileObj[] = [];\n  response: string;\n  enableCustomDownload = true;\n  private shouldSaveAttachment: boolean;\n\n  existingAttachmentName: string = this.request[RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.fields.attachment];\n\n  constructor(\n    private activeModalRef: ActiveModalRef,\n    private rxRecordInstanceService: RxRecordInstanceService,\n    private rxNotificationService: RxNotificationService,\n    private translateService: TranslateService,\n    private rxApprovalConsoleService: RxApprovalConsoleService,\n    protected injector: Injector\n  ) {\n    super(activeModalRef, injector);\n  }\n\n  isDirty(): boolean {\n    return !this.isSaveButtonDisabled();\n  }\n\n  ngOnInit(): void {\n    super.ngOnInit();\n\n    if (this.existingAttachmentName) {\n      this.attachment = this.getExistingFile();\n    }\n  }\n\n  sendResponse(): void {\n    this.allowDismiss = false;\n\n    this.rxRecordInstanceService\n      .get(RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.definition, this.request[RX_RECORD_DEFINITION.coreFieldIds.id])\n      .pipe(\n        switchMap((recordInstance: RecordInstance) => {\n          recordInstance.setFieldValue(\n            Number(RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.fields.response),\n            this.response\n          );\n\n          return this.rxRecordInstanceService.save(recordInstance);\n        }),\n        tap(() => {\n          this.rxNotificationService.addSuccessMessage(\n            this.translateService.instant(\n              'com.bmc.arsys.rx.client.approval.console.question-response-dialog.response-added.message'\n            )\n          );\n        }),\n        switchMap(() => {\n          if (this.shouldSaveAttachment) {\n            const recordInstanceFormData = new FormData();\n\n            recordInstanceFormData.append(\n              RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.fields.attachment,\n              this.attachment[0].data,\n              this.attachment[0].data.name\n            );\n\n            return this.rxApprovalConsoleService.saveAttachment(\n              recordInstanceFormData,\n              this.request[RX_RECORD_DEFINITION.coreFieldIds.id]\n            );\n          } else {\n            return of(null);\n          }\n        }),\n        finalize(() => {\n          this.allowDismiss = true;\n        })\n      )\n      .subscribe(() => {\n        this.activeModalRef.close(true);\n      });\n  }\n\n  onRemovedFileFromQueue(): void {\n    this.enableCustomDownload = false;\n  }\n\n  onAfterFilesAdded(): void {\n    this.shouldSaveAttachment = true;\n  }\n\n  downloadAttachment = () => {\n    this.rxRecordInstanceService.downloadAttachment(\n      RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.definition,\n      Number(RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.fields.attachment),\n      this.request[RX_RECORD_DEFINITION.coreFieldIds.id],\n      this.request[RX_APPROVAL_CONSOLE.needAttentionRequestsGrid.fields.attachment]\n    );\n  };\n\n  cancel(): void {\n    this.activeModalRef.dismiss(DismissReasons.CLOSE_BTN);\n  }\n\n  private getExistingFile(): FileObj[] {\n    return [\n      {\n        data: new File([], this.existingAttachmentName),\n        inUploading: false,\n        inDeleting: false,\n        uploaded: 100,\n        error: false,\n        errorText: '',\n        allowDeletion: true\n      }\n    ];\n  }\n\n  isSaveButtonDisabled(): boolean {\n    return !this.allowDismiss || !this.response || (this.existingAttachmentName && !this.attachment[0]?.data);\n  }\n}\n","<div class=\"modal-header\">\n  <h5 class=\"modal-title\">\n    {{ 'com.bmc.arsys.rx.client.approval.console.question-response-dialog.title' | translate }}\n  </h5>\n\n  <button\n    class=\"close dp-close\"\n    type=\"button\"\n    rx-id=\"x-button\"\n    [disabled]=\"!allowDismiss\"\n    (click)=\"cancel()\"\n  ></button>\n</div>\n\n<div class=\"modal-body\">\n  <rx-read-only-field\n    class=\"d-block form-group\"\n    label=\"{{ 'com.bmc.arsys.rx.client.approval.console.question-response-dialog.to-field.label' | translate }}\"\n    value=\"{{ request['2'] }}\"\n  ></rx-read-only-field>\n\n  <rx-read-only-field\n    class=\"d-block form-group\"\n    label=\"{{ 'com.bmc.arsys.rx.client.common.question.label' | translate }}\"\n    value=\"{{ request['13300'] }}\"\n  ></rx-read-only-field>\n\n  <adapt-rx-textarea\n    label=\"{{ 'com.bmc.arsys.rx.client.approval.console.question-response-dialog.response-field.label' | translate }}\"\n    class=\"d-block form-group\"\n    [(ngModel)]=\"response\"\n    [required]=\"true\"\n    [autofocus]=\"true\"\n    rows=\"2\"\n  ></adapt-rx-textarea>\n\n  <adapt-rx-uploader\n    adaptRequired\n    [(ngModel)]=\"attachment\"\n    [required]=\"existingAttachmentName\"\n    [showMaxSizeRestriction]=\"false\"\n    (removedFileFromQueue)=\"onRemovedFileFromQueue()\"\n    (afterFilesAdded)=\"onAfterFilesAdded()\"\n    [enableCustomDownload]=\"enableCustomDownload\"\n    [customDownload]=\"downloadAttachment\"\n    [reusable]=\"true\"\n    label=\"{{ 'com.bmc.arsys.rx.client.common.attachment.label' | translate }}\"\n  >\n  </adapt-rx-uploader>\n</div>\n\n<div class=\"modal-footer\">\n  <button\n    adapt-button\n    class=\"mr-2\"\n    btn-type=\"primary\"\n    type=\"button\"\n    rx-id=\"save-button\"\n    [disabled]=\"isSaveButtonDisabled()\"\n    [adaptInlineLoader]=\"!allowDismiss\"\n    (click)=\"sendResponse()\"\n  >\n    {{ 'com.bmc.arsys.rx.client.common.save.label' | translate }}\n  </button>\n\n  <button\n    adapt-button\n    type=\"button\"\n    btn-type=\"secondary\"\n    rx-id=\"cancel-button\"\n    (click)=\"cancel()\"\n    [disabled]=\"!allowDismiss\"\n  >\n    {{ 'com.bmc.arsys.rx.client.common.cancel.label' | translate }}\n  </button>\n</div>\n"]}