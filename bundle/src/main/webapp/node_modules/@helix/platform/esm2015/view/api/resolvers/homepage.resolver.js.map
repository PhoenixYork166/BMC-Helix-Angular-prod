{"version":3,"file":"homepage.resolver.js","sourceRoot":"","sources":["../../../../../../../libs/platform/view/api/resolvers/homepage.resolver.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\nimport { ActivatedRouteSnapshot, CanActivate, Router, RouterStateSnapshot, UrlTree } from '@angular/router';\nimport {\n  IBundleDescriptor,\n  RX_APPLICATION,\n  RxComponentCanDeactivateGuard,\n  RxGlobalCacheService,\n  RxLocalizationService,\n  RxSessionService\n} from '@helix/platform/shared/api';\nimport { find, findIndex, get, head } from 'lodash';\nimport { combineLatest, Observable, of } from 'rxjs';\nimport { concatMap, map, switchMap, tap } from 'rxjs/operators';\nimport { RX_SHELL, RxShellService } from '../shell';\nimport { RxTreeService } from '@helix/platform/utils';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class RxHomepageResolver implements CanActivate {\n  private unknownApplicationRoute = '/unknown-application';\n\n  constructor(\n    private rxGlobalCacheService: RxGlobalCacheService,\n    private rxShellService: RxShellService,\n    private rxTreeService: RxTreeService,\n    private router: Router,\n    private rxSessionService: RxSessionService,\n    private rxComponentCanDeactivateGuard: RxComponentCanDeactivateGuard,\n    private rxLocalizationService: RxLocalizationService\n  ) {}\n\n  canActivate(\n    route: ActivatedRouteSnapshot,\n    state: RouterStateSnapshot\n  ): Observable<boolean | UrlTree> | Promise<boolean | UrlTree> | boolean | UrlTree {\n    const bundleId = route.paramMap.get('bundleId');\n    const applicationId = head(route.url).path;\n    const useDefaultLang = applicationId === RX_APPLICATION.innovationStudioBundleId;\n    const initTranslations$ = this.rxLocalizationService.initTranslations(useDefaultLang);\n\n    // waiting for translations to resolve to make getShellConfig call with correct lang\n    return combineLatest([this.rxSessionService.sessionActive$, initTranslations$]).pipe(\n      switchMap(() => {\n        return this.rxGlobalCacheService\n          .getBundleDescriptors()\n          .pipe(concatMap((bundleDescriptors) => this.getBundleUrl(bundleDescriptors, bundleId)));\n      }),\n      tap(() => this.rxComponentCanDeactivateGuard.disable())\n    );\n  }\n\n  private getBundleUrl(bundleDescriptors: IBundleDescriptor[], bundleId: string): Observable<UrlTree | boolean> {\n    if (findIndex(bundleDescriptors, { id: bundleId }) !== -1) {\n      return this.rxShellService.getShellConfig(bundleId).pipe(\n        map((shellConfiguration) => {\n          const menuItems = get(\n            this.rxTreeService.flattenTree(shellConfiguration, 'navigationBarItems'),\n            '[0].flattenedMenuItems'\n          );\n\n          const defaultView = find(menuItems, {\n            type: RX_SHELL.actions.navigateToView\n          });\n\n          return this.generateUrl(defaultView, bundleId);\n        })\n      );\n    } else {\n      return of(this.router.parseUrl(this.unknownApplicationRoute));\n    }\n  }\n\n  private generateUrl(defaultView, bundleId): UrlTree {\n    return this.router.parseUrl(\n      defaultView\n        ? `/${bundleId}/view/${defaultView.viewUrl}`\n        : `/${bundleId}/view/${RX_APPLICATION.settingsBundleId}:Unknown Default View Error)}`\n    );\n  }\n}\n"]}