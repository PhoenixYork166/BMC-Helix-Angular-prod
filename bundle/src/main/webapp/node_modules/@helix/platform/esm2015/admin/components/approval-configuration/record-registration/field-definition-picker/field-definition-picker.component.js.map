{"version":3,"file":"field-definition-picker.component.js","sourceRoot":"","sources":["../../../../../../../../../libs/platform/admin/components/approval-configuration/record-registration/field-definition-picker/field-definition-picker.component.ts","../../../../../../../../../libs/platform/admin/components/approval-configuration/record-registration/field-definition-picker/field-definition-picker.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, ElementRef, Input, OnChanges, Renderer2, SimpleChanges, ViewChild } from '@angular/core';\nimport { NG_VALUE_ACCESSOR } from '@angular/forms';\nimport {\n  FieldsTree,\n  IFieldDefinitionPickerComponentOptions,\n  IRecordFields\n} from './field-definition-picker-component.types';\nimport { AdaptDropdownDirective } from '@bmc-ux/adapt-angular';\nimport { IRecordDefinition, RxRecordDefinitionCacheService } from '@helix/platform/record/api';\nimport { ValueAccessor } from '@helix/platform/shared/components';\nimport { RxDefinitionNameService } from '@helix/platform/shared/api';\nimport { RxRecordGridUtilsService } from '@helix/platform/view/components';\nimport { TranslateService } from '@ngx-translate/core';\nimport { RxFieldDefinitionPickerService } from './field-definition-picker.service';\nimport { IValueWithLabel, RxObjectUtilsService, RxStringService } from '@helix/platform/utils';\nimport { map, mergeMap } from 'rxjs/operators';\nimport { Observable } from 'rxjs';\n\n@Component({\n  selector: 'rx-field-definition-picker',\n  templateUrl: './field-definition-picker.component.html',\n  styleUrls: ['./field-definition-picker.component.scss'],\n  providers: [\n    {\n      provide: NG_VALUE_ACCESSOR,\n      useExisting: RxFieldDefinitionPickerComponent,\n      multi: true\n    }\n  ]\n})\nexport class RxFieldDefinitionPickerComponent extends ValueAccessor<string> implements OnChanges {\n  @Input()\n  options: IFieldDefinitionPickerComponentOptions;\n\n  @ViewChild('dropdownButton', { static: true })\n  dropdownButton: ElementRef;\n\n  @ViewChild('fieldDefinitionPicker', { static: true })\n  dropdown: AdaptDropdownDirective;\n\n  defaultText = this.translateService.instant('com.bmc.arsys.rx.client.common.select.label');\n  dropdownWidth: number;\n  filteredFieldsTree: FieldsTree = [];\n  label: string;\n  searchText = '';\n\n  constructor(\n    private rxDefinitionNameService: RxDefinitionNameService,\n    private rxRecordGridUtilsService: RxRecordGridUtilsService,\n    private rxRecordDefinitionCacheService: RxRecordDefinitionCacheService,\n    private translateService: TranslateService,\n    private rxFieldDefinitionPickerService: RxFieldDefinitionPickerService,\n    private rxStringService: RxStringService,\n    private rxObjectUtilsService: RxObjectUtilsService,\n    private renderer: Renderer2\n  ) {\n    super();\n  }\n\n  ngOnChanges(changes: SimpleChanges): void {\n    const fieldsTree = changes.options.currentValue?.fieldsTree;\n\n    if (fieldsTree?.length) {\n      this.filteredFieldsTree = this.rxObjectUtilsService.cloneDeep(fieldsTree);\n    } else {\n      this.filteredFieldsTree = [];\n    }\n\n    this.updateFieldLabel();\n  }\n\n  setDropdownWidth(): void {\n    const dropdownButton = this.renderer.selectRootElement(this.dropdownButton.nativeElement, true);\n\n    this.dropdownWidth = dropdownButton.clientWidth + 2;\n  }\n\n  selectField(fieldNode: IValueWithLabel): void {\n    this.dropdown.close();\n    this.label = fieldNode.label;\n    this.value = fieldNode.value;\n  }\n\n  clearFieldDefinition(e: Event): void {\n    e.stopPropagation();\n    this.reset();\n  }\n\n  reset(): void {\n    this.label = '';\n    this.value = '';\n  }\n\n  private updateFieldLabel(): void {\n    if (this.value) {\n      if (this.value.indexOf('associations') !== -1) {\n        this.initializeAssociatedFieldLabel().subscribe((fieldLabel) => (this.label = fieldLabel));\n      } else {\n        this.label = this.value;\n      }\n    } else {\n      this.label = '';\n    }\n  }\n\n  private initializeAssociatedFieldLabel(): Observable<string> {\n    if (this.options.recordDefinitionName) {\n      return this.rxRecordDefinitionCacheService\n        .getRecordDefinition(this.options.recordDefinitionName)\n        .pipe(\n          mergeMap((recordDefinition: IRecordDefinition) =>\n            this.rxRecordGridUtilsService\n              .getFieldDefinition(this.value, recordDefinition)\n              .pipe(map((fieldDefinition) => fieldDefinition.name))\n          )\n        );\n    }\n  }\n\n  filterFields(searchText: string): void {\n    this.filteredFieldsTree = this.rxObjectUtilsService.cloneDeep(this.options.fieldsTree);\n\n    if (searchText) {\n      this.filteredFieldsTree = this.filteredFieldsTree\n        .map((recordFields: IRecordFields) => ({\n          ...recordFields,\n          fields: recordFields.fields.filter((fieldDefinitionData: IValueWithLabel) =>\n            this.rxStringService.caseInsensitiveSearch(fieldDefinitionData.label, searchText)\n          )\n        }))\n        .filter((recordFields: IRecordFields) => recordFields.fields.length);\n    }\n  }\n}\n","<div class=\"d-flex\">\n  <adapt-rx-control-label *ngIf=\"options.label\" [label]=\"options.label\" [showRequiredLabel]=\"options.required\">\n  </adapt-rx-control-label>\n\n  <span\n    *ngIf=\"options?.tooltip\"\n    class=\"d-icon-right-question_circle_o ml-2\"\n    [adaptPopover]=\"options.tooltip\"\n    placement=\"right\"\n    appendToBody=\"true\"\n  >\n  </span>\n</div>\n\n<div\n  class=\"dropdown\"\n  adaptDropdown\n  appendToBody=\"true\"\n  [autoClose]=\"'outside'\"\n  [autoFocusFirst]=\"false\"\n  #fieldDefinitionPicker=\"adaptDropdown\"\n>\n  <button\n    rx-id=\"toggle-button\"\n    #dropdownButton\n    class=\"btn btn-secondary\"\n    (click)=\"setDropdownWidth()\"\n    adaptDropdownToggle\n    type=\"button\"\n    [disabled]=\"!options.recordDefinitionName\"\n  >\n    <span class=\"rx-selected-item rx-ellipsis\">{{ label || defaultText }}</span>\n\n    <span\n      rx-id=\"clear-button\"\n      class=\"d-icon-cross_adapt btn-link\"\n      *ngIf=\"value && !isDisabled\"\n      (click)=\"clearFieldDefinition($event)\"\n    >\n    </span>\n  </button>\n\n  <div class=\"dropdown-menu p-0\" [style.width.px]=\"dropdownWidth\" adaptDropdownMenu>\n    <div class=\"dropdown-header\">\n      <adapt-rx-search\n        [(ngModel)]=\"searchText\"\n        placeholder=\"{{ 'com.bmc.arsys.rx.client.common.filter-data.label' | translate }}\"\n        debounceTime=\"250\"\n        class=\"py-2\"\n        (ngModelChange)=\"filterFields($event)\"\n      >\n      </adapt-rx-search>\n    </div>\n\n    <ul class=\"records\" *ngIf=\"filteredFieldsTree.length\">\n      <li\n        class=\"record rx-ellipsis\"\n        *ngFor=\"let recordNode of filteredFieldsTree\"\n        (click)=\"recordNode.isExpanded = !recordNode.isExpanded\"\n      >\n        <span rx-id=\"expand-button\" class=\"expand-arrow d-icon-angle_right\" [class.open]=\"recordNode.isExpanded\"></span>\n\n        <span\n          class=\"px-1\"\n          [ngClass]=\"recordNode.isAssociatedRecord ? 'd-icon-arrow_schema' : 'd-icon-file_text'\"\n        ></span>\n\n        <span> {{ recordNode.label }} </span>\n\n        <div class=\"fields\" *ngIf=\"recordNode.isExpanded\">\n          <button\n            class=\"dropdown-item rx-ellipsis\"\n            (click)=\"$event.stopPropagation(); selectField(fieldNode)\"\n            type=\"button\"\n            [class.active]=\"value === fieldNode.label\"\n            *ngFor=\"let fieldNode of recordNode.fields\"\n          >\n            <adapt-highlight [result]=\"fieldNode.label\" [term]=\"searchText\"></adapt-highlight>\n          </button>\n        </div>\n      </li>\n    </ul>\n  </div>\n</div>\n"]}