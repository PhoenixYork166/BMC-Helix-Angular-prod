{"version":3,"file":"process-designer.service.js","sourceRoot":"","sources":["../../../../../../../libs/platform/process/designer/process-designer/process-designer.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\nimport { chain, find, reduce, some } from 'lodash';\n\nimport {\n  IActionType,\n  IBundleDescriptor,\n  RX_DESIGNER,\n  RX_DESIGNER_ELEMENT_SHAPE,\n  RxActionTypeUtilsService,\n  RxBundleCacheService,\n  RxDesignerCacheService,\n  RxGlobalCacheService\n} from '@helix/platform/shared/api';\nimport { IDesignerPaletteNode, IDesignerPaletteTree } from '@helix/platform/shared/components';\nimport {\n  IProcessElementDescriptor,\n  RX_PROCESS_DEFINITION,\n  RxProcessDefinitionService,\n  RxProcessElementRegistryService\n} from '@helix/platform/process/api';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class RxProcessDesignerService {\n  constructor(\n    private rxActionTypeUtilsService: RxActionTypeUtilsService,\n    private rxBundleCacheService: RxBundleCacheService,\n    private rxDesignerCacheService: RxDesignerCacheService,\n    private rxGlobalCacheService: RxGlobalCacheService,\n    private rxProcessDefinitionService: RxProcessDefinitionService,\n    private rxProcessElementRegistryService: RxProcessElementRegistryService\n  ) {}\n\n  buildPalette(actionTypes: IActionType[], bundleDescriptors: IBundleDescriptor[]): IDesignerPaletteTree[] {\n    const registeredElementNodes = reduce<IProcessElementDescriptor, IDesignerPaletteNode[]>(\n      this.rxProcessElementRegistryService.getAll(),\n      (nodes, registeredElement) => {\n        if (registeredElement.displayName) {\n          nodes.push({\n            group: registeredElement.group,\n            label: registeredElement.displayName,\n            paletteItem: registeredElement.paletteItem,\n            value: {\n              actionTypeName: this.rxProcessDefinitionService.getServerActionTypeName(registeredElement.type),\n              resourceType: registeredElement.resourceType,\n              type: registeredElement.type\n            }\n          });\n        }\n\n        return nodes;\n      },\n      []\n    );\n\n    const serverActionNodes = reduce<IActionType, IDesignerPaletteNode[]>(\n      actionTypes,\n      (nodes, actionType) => {\n        const isActionRegistered = some(\n          registeredElementNodes,\n          (registeredElementNode) => registeredElementNode.value.actionTypeName === actionType.actionTypeName\n        );\n\n        if (!isActionRegistered) {\n          nodes.push({\n            group:\n              this.rxActionTypeUtilsService.getActionTypeBundleFriendlyName(bundleDescriptors, actionType) ||\n              RX_PROCESS_DEFINITION.standardProcessElementGroups.platformActions.name,\n            label:\n              actionType.displayName || this.rxActionTypeUtilsService.prettifyActionTypeName(actionType.actionTypeName),\n            paletteItem: {\n              border: RX_DESIGNER.paletteItemBorder.solid,\n              icon: {\n                path: actionType.isDeprecated\n                  ? RX_DESIGNER_ELEMENT_SHAPE.bpmnIcons.info\n                  : RX_DESIGNER_ELEMENT_SHAPE.bpmnIcons.gear,\n                position: RX_DESIGNER.paletteIconPosition.top\n              },\n              label: RX_DESIGNER.paletteItemLabel.inner,\n              shape: RX_DESIGNER.paletteItemShape.rectangle\n            },\n            value: {\n              actionTypeName: actionType.actionTypeName,\n              resourceType: RX_PROCESS_DEFINITION.processElementResourceTypes.processAction,\n              type: this.rxProcessDefinitionService.getServerActionModelType(actionType.actionTypeName)\n            }\n          });\n        }\n\n        return nodes;\n      },\n      []\n    );\n\n    return chain([...registeredElementNodes, ...serverActionNodes])\n      .sortBy('label')\n      .reduce<IDesignerPaletteTree[]>((tree, element) => {\n        const group = find(tree, { label: element.group });\n\n        if (group) {\n          group.children.push(element);\n        } else {\n          tree.push({\n            label: element.group,\n            children: [element]\n          });\n        }\n\n        return tree;\n      }, [])\n      .sortBy('label')\n      .sortBy((node) => {\n        const group = find(RX_PROCESS_DEFINITION.processElementGroups, { name: node.label });\n\n        return group?.priority ?? RX_PROCESS_DEFINITION.standardProcessElementGroups.default.priority;\n      })\n      .value();\n  }\n}\n"]}