{"version":3,"file":"record-editor-builder.service.js","sourceRoot":"","sources":["../../../../../../../libs/com-bmc-arsys-rx-innovationstudio/src/lib/components/data-editor/record-editor-builder.service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable } from '@angular/core';\nimport { reject } from 'lodash';\nimport { RxGuidService } from '@helix/platform/utils';\nimport {\n  IViewComponentDefinition,\n  IViewDefinition,\n  RX_VIEW_DEFINITION,\n  RxViewComponentType\n} from '@helix/platform/view/api';\nimport { IRecordDefinition, RX_RECORD_DEFINITION, RxFieldDefinitionService } from '@helix/platform/record/api';\nimport { TranslateService } from '@ngx-translate/core';\nimport { ContainerRowWrap, RecordEditorMode, RxDefaultRecordEditorInputType } from '@helix/platform/view/components';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class RxRecordEditorBuilder {\n  constructor(\n    private rxGuidService: RxGuidService,\n    private rxDefaultRecordEditorInputType: RxDefaultRecordEditorInputType,\n    private rxFieldDefinitionService: RxFieldDefinitionService,\n    private translateService: TranslateService\n  ) {}\n\n  getViewDefinition(\n    recordDefinition: IRecordDefinition,\n    recordInstanceId: string,\n    isEditable: boolean = true\n  ): IViewDefinition {\n    const closeButtonId = this.rxGuidService.generate();\n    const containerId = this.rxGuidService.generate();\n    const recordEditorId = this.rxGuidService.generate();\n    const saveButtonId = this.rxGuidService.generate();\n    const viewDefinitionId = this.rxGuidService.generate();\n    const recordEditorMode = recordInstanceId ? RecordEditorMode.Edit : RecordEditorMode.Create;\n\n    const recordEditorComponentDefinitions = this.getComponentDefinitions(\n      recordDefinition,\n      recordEditorMode,\n      recordEditorId\n    );\n\n    return {\n      guid: viewDefinitionId,\n      layout: JSON.stringify({\n        outlets: [\n          {\n            name: 'DEFAULT',\n            columns: [\n              {\n                children: [recordEditorId]\n              }\n            ]\n          },\n          {\n            name: 'footer',\n            height: 60,\n            columns: [\n              {\n                children: [containerId]\n              }\n            ]\n          }\n        ]\n      }),\n      outputParams: [\n        {\n          name: 'recordInstance',\n          source: '${view.components.' + recordEditorId + '.recordInstance}'\n        }\n      ],\n      inputParams: [],\n      componentDefinitions: [\n        {\n          resourceType: RX_VIEW_DEFINITION.resourceTypes.containerViewComponent,\n          guid: recordEditorId,\n          type: RxViewComponentType.RecordEditor,\n          propertiesByName: {\n            recordInstanceId: `\"${recordInstanceId}\"`,\n            mode: recordEditorMode,\n            recordDefinitionName: recordDefinition.name,\n            styles: 'p-0 border-0',\n            allowEdit: isEditable ? '1' : '0'\n          },\n          componentDefinitions: recordEditorComponentDefinitions,\n          layout: JSON.stringify({\n            outlets: [\n              {\n                name: 'DEFAULT',\n                columns: [\n                  {\n                    children: recordEditorComponentDefinitions.map((componentDefinition) => componentDefinition.guid)\n                  }\n                ]\n              }\n            ]\n          })\n        },\n        {\n          resourceType: RX_VIEW_DEFINITION.resourceTypes.containerViewComponent,\n          guid: containerId,\n          type: RxViewComponentType.ButtonBar,\n          propertiesByName: {\n            alignment: 'right',\n            hidden: '0'\n          },\n          layout: JSON.stringify({\n            outlets: [\n              {\n                name: 'DEFAULT',\n                columns: [\n                  {\n                    children: [saveButtonId, closeButtonId]\n                  }\n                ]\n              }\n            ]\n          }),\n          componentDefinitions: [\n            {\n              resourceType: RX_VIEW_DEFINITION.resourceTypes.containerViewComponent,\n              guid: closeButtonId,\n              type: RxViewComponentType.ActionButton,\n              propertiesByName: {\n                label: isEditable\n                  ? this.translateService.instant('com.bmc.arsys.rx.client.common.cancel.label')\n                  : this.translateService.instant('com.bmc.arsys.rx.client.common.close.label'),\n                style: 'secondary',\n                size: 'default'\n              },\n              componentDefinitions: [\n                {\n                  resourceType: RX_VIEW_DEFINITION.resourceTypes.viewComponent,\n                  guid: this.rxGuidService.generate(),\n                  type: RxViewComponentType.Action,\n                  propertiesByName: {\n                    viewApi: '${view.api}',\n                    name: 'rxCloseViewAction',\n                    actAsCancel: 'true'\n                  }\n                }\n              ]\n            },\n            {\n              resourceType: RX_VIEW_DEFINITION.resourceTypes.containerViewComponent,\n              guid: saveButtonId,\n              type: RxViewComponentType.ActionButton,\n              propertiesByName: {\n                label: this.translateService.instant('com.bmc.arsys.rx.client.common.save.label'),\n                hidden: isEditable ? '0' : '1',\n                style: 'primary',\n                disabled: 'NOT${view.components.' + recordEditorId + '.canSave}',\n                size: 'default'\n              },\n              componentDefinitions: [\n                {\n                  resourceType: RX_VIEW_DEFINITION.resourceTypes.viewComponent,\n                  guid: this.rxGuidService.generate(),\n                  type: RxViewComponentType.Action,\n                  propertiesByName: {\n                    viewApi: '${view.api}',\n                    name: 'rxSaveAction',\n                    targetApi: '${view.api}',\n                    closeAfterSave: true\n                  }\n                }\n              ]\n            }\n          ]\n        }\n      ]\n    };\n  }\n\n  private getComponentDefinitions(\n    recordDefinition: IRecordDefinition,\n    recordEditorMode,\n    recordEditorId: string\n  ): IViewComponentDefinition[] {\n    const fieldGroupFilters = [RX_RECORD_DEFINITION.fieldOptions.required, RX_RECORD_DEFINITION.fieldOptions.optional];\n\n    if (recordEditorMode === RecordEditorMode.Edit) {\n      fieldGroupFilters.push(RX_RECORD_DEFINITION.fieldOptions.system);\n    }\n\n    const componentDefinitions = [];\n\n    for (let i = 0; i < fieldGroupFilters.length; i++) {\n      const recordFieldsComponentDefinitions = this.getFieldComponentDefinitions(\n        recordDefinition,\n        recordEditorMode,\n        recordEditorId,\n        fieldGroupFilters[i]\n      );\n\n      componentDefinitions.push({\n        resourceType: RX_VIEW_DEFINITION.resourceTypes.containerViewComponent,\n        guid: this.rxGuidService.generate(),\n        type: RxViewComponentType.Container,\n        propertiesByName: {\n          rowWrap: ContainerRowWrap.Sm,\n          columnCount: '2',\n          styles: i + 1 !== fieldGroupFilters.length ? 'border-bottom pb-4' : ''\n        },\n        componentDefinitions: recordFieldsComponentDefinitions,\n        layout: JSON.stringify({\n          outlets: [\n            {\n              name: 'DEFAULT',\n              columns: [\n                {\n                  children: recordFieldsComponentDefinitions\n                    .filter((componentDefinition, index) => index % 2 === 0)\n                    .map((componentDefinition) => componentDefinition.guid),\n                  span: '6'\n                },\n                {\n                  children: recordFieldsComponentDefinitions\n                    .filter((componentDefinition, index) => index % 2 === 1)\n                    .map((componentDefinition) => componentDefinition.guid),\n                  span: '6'\n                }\n              ]\n            }\n          ]\n        })\n      });\n    }\n\n    return componentDefinitions;\n  }\n\n  private getFieldComponentDefinitions(\n    recordDefinition: IRecordDefinition,\n    recordEditorMode,\n    recordEditorId: string,\n    fieldGroupFilter: string\n  ): IViewComponentDefinition[] {\n    return reject(\n      recordDefinition.fieldDefinitions,\n      (fieldDefinition) =>\n        recordEditorMode === RecordEditorMode.Create && this.rxFieldDefinitionService.isSystemField(fieldDefinition)\n    )\n      .filter((fieldDefinition) => fieldDefinition.fieldOption === fieldGroupFilter)\n      .map((fieldDefinition) => {\n        const componentDefinition: IViewComponentDefinition = {\n          resourceType: RX_VIEW_DEFINITION.resourceTypes.viewComponent,\n          guid: this.rxGuidService.generate(),\n          type: this.rxDefaultRecordEditorInputType.getFieldTypeByFieldDefinition(fieldDefinition),\n          propertiesByName: {\n            fieldId: fieldDefinition.id,\n            recordDefinition: '${view.components.' + recordEditorId + '.recordDefinition}',\n            recordInstance: '${view.components.' + recordEditorId + '.recordInstance}',\n            label: fieldDefinition.name\n          }\n        };\n\n        if (\n          fieldDefinition.resourceType === RX_RECORD_DEFINITION.dataTypes.character.resourceType &&\n          fieldDefinition.namedListDefinition\n        ) {\n          componentDefinition.propertiesByName.enableMultiSelection = 'true';\n        }\n\n        return componentDefinition;\n      })\n      .sort((a, b) => a.propertiesByName.label.localeCompare(b.propertiesByName.label));\n  }\n}\n"]}