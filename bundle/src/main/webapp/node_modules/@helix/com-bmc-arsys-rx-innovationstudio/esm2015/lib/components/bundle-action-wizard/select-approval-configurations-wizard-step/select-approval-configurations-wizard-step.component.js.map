{"version":3,"file":"select-approval-configurations-wizard-step.component.js","sourceRoot":"","sources":["../../../../../../../../libs/com-bmc-arsys-rx-innovationstudio/src/lib/components/bundle-action-wizard/select-approval-configurations-wizard-step/select-approval-configurations-wizard-step.component.ts","../../../../../../../../libs/com-bmc-arsys-rx-innovationstudio/src/lib/components/bundle-action-wizard/select-approval-configurations-wizard-step/select-approval-configurations-wizard-step.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, Input, OnDestroy, OnInit, ViewChild } from '@angular/core';\nimport { combineLatest, Observable, of, ReplaySubject } from 'rxjs';\nimport { map, switchMap, take, takeUntil } from 'rxjs/operators';\nimport { chain, cloneDeep, find, map as _map, reduce } from 'lodash';\nimport { TranslateService } from '@ngx-translate/core';\nimport { IRecordDefinition, RX_RECORD_DEFINITION } from '@helix/platform/record/api';\nimport {\n  IPlainObject,\n  RxDataPageFactoryService,\n  RxDefinitionNameService,\n  RxSessionExpirationService\n} from '@helix/platform/shared/api';\nimport { RxWizardModalComponent } from '@helix/platform/shared/components';\nimport {\n  ColumnSortDirection,\n  IRecordGridColumn,\n  IRecordGridConfig,\n  RecordGridComponent\n} from '@helix/platform/view/components';\nimport { ICreateContentPackageContext, IDeploymentPackageDescriptor } from '../../bundle-details/bundle-details.types';\n\n@Component({\n  selector: 'ax-select-approval-configurations-wizard-step',\n  templateUrl: 'select-approval-configurations-wizard-step.component.html',\n  styleUrls: ['./select-approval-configurations-wizard-step.component.scss']\n})\nexport class SelectApprovalConfigurationsWizardStepComponent implements OnInit, OnDestroy {\n  @Input()\n  context: ICreateContentPackageContext;\n\n  @Input()\n  options: IPlainObject;\n\n  @ViewChild(RecordGridComponent, { static: true })\n  recordGrid: RecordGridComponent;\n\n  recordGridConfig$: Observable<IRecordGridConfig>;\n  selectedDefinitionCount: number;\n\n  private destroyed$: ReplaySubject<boolean> = new ReplaySubject(1);\n\n  constructor(\n    private rxDataPageService: RxDataPageFactoryService,\n    private rxDefinitionNameService: RxDefinitionNameService,\n    private rxSessionExpirationService: RxSessionExpirationService,\n    private translateService: TranslateService,\n    private rxWizardModalComponent: RxWizardModalComponent\n  ) {}\n\n  ngOnInit(): void {\n    const columns: IRecordGridColumn[] = [\n      {\n        title: this.translateService.instant(\n          'com.bmc.arsys.rx.innovation-studio.bundle-action-wizard.record-definition.label'\n        ),\n        fieldId: 'recordDefinitionName',\n        sortable: { direction: ColumnSortDirection.Asc, priority: 0 }\n      },\n      {\n        title: this.translateService.instant(\n          'com.bmc.arsys.rx.innovation-studio.bundle-action-wizard.select-approval-configurations.flow-group.label'\n        ),\n        fieldId: 'flowGroupName',\n        sortable: { direction: ColumnSortDirection.Asc, priority: 1 }\n      }\n    ];\n\n    const recordDefinition: IRecordDefinition = {\n      fieldDefinitions: [\n        {\n          id: 'recordDefinitionName',\n          resourceType: RX_RECORD_DEFINITION.dataTypes.character.resourceType\n        },\n        {\n          id: 'flowGroupName',\n          resourceType: RX_RECORD_DEFINITION.dataTypes.character.resourceType\n        }\n      ]\n    };\n\n    this.recordGridConfig$ = of({\n      columns,\n      enableColumnSelection: false,\n      enableRowSelection: this.options.gridConfig?.enableRowSelection,\n      recordIdField: 'definitionNameWithFlowGroup',\n      styles: 'flex-fill',\n      useExternalFiltering: false,\n      expandGroups: true,\n      getRecordDefinition: () => of(recordDefinition),\n      getData: () => {\n        this.rxWizardModalComponent.api.disableNextButton();\n\n        return this.rxSessionExpirationService.keepSessionAlive().pipe(\n          switchMap(() =>\n            this.rxDataPageService\n              .withType('com.bmc.arsys.rx.approval.application.datapage.ApprovalConfigurationsDataPageQuery')\n              .get({\n                params: {\n                  startIndex: -1,\n                  pageSize: 0,\n                  bundleId: this.context.deploymentPackageDescriptor.id\n                }\n              })\n              .pipe(\n                map((response) => {\n                  this.selectedDefinitionCount = 0;\n\n                  const data = reduce(\n                    response.data[0],\n                    (result, flowGroupNames, recordDefinitionName) => {\n                      const bundleFriendlyName =\n                        this.context.bundleFriendlyNamesById[\n                          this.rxDefinitionNameService.getBundleId(recordDefinitionName)\n                        ];\n\n                      const recordDefinitionDisplayName =\n                        this.rxDefinitionNameService.getDisplayName(recordDefinitionName);\n\n                      let dataItem = find(result, { groupValue: bundleFriendlyName });\n\n                      if (dataItem) {\n                        flowGroupNames.forEach((flowGroupName) => {\n                          dataItem.items.push({\n                            definitionName: recordDefinitionName,\n                            bundleName: bundleFriendlyName,\n                            recordDefinitionName: recordDefinitionDisplayName,\n                            flowGroupName,\n                            definitionNameWithFlowGroup: `${flowGroupName}:${recordDefinitionName}`\n                          });\n                        });\n                      } else {\n                        dataItem = {\n                          groupValue: bundleFriendlyName,\n                          groupField: 'bundleName',\n                          items: flowGroupNames.map((flowGroupName) => ({\n                            definitionName: recordDefinitionName,\n                            bundleName: bundleFriendlyName,\n                            recordDefinitionName: recordDefinitionDisplayName,\n                            flowGroupName,\n                            definitionNameWithFlowGroup: `${flowGroupName}:${recordDefinitionName}`\n                          }))\n                        };\n\n                        result.push(dataItem);\n                      }\n\n                      return result;\n                    },\n                    []\n                  );\n\n                  return {\n                    data,\n                    totalSize: data.length\n                  };\n                })\n              )\n          )\n        );\n      }\n    });\n\n    combineLatest([this.recordGrid.rowSelectionChanged, this.rxWizardModalComponent.context$.pipe(take(1))])\n      .pipe(takeUntil(this.destroyed$))\n      .subscribe(([selectedRows, context]) => {\n        this.selectedDefinitionCount = selectedRows.length;\n\n        const newDeploymentPackageDescriptor: IDeploymentPackageDescriptor = cloneDeep(\n          context.deploymentPackageDescriptor\n        );\n\n        newDeploymentPackageDescriptor.approvalConfigurationQueryOptions = chain(selectedRows)\n          .groupBy('definitionName')\n          .map((config, definitionName) => ({\n            recordDefinitionName: definitionName,\n            flowGroups: _map(config, 'flowGroupName')\n          }))\n          .value();\n\n        this.rxWizardModalComponent.api.updateContext(\n          {\n            deploymentPackageDescriptor: newDeploymentPackageDescriptor,\n            isPackageDataModified: true\n          },\n          this.selectedDefinitionCount > 0\n        );\n      });\n  }\n\n  ngOnDestroy(): void {\n    this.destroyed$.next();\n    this.destroyed$.complete();\n  }\n\n  onDataLoaded(): void {\n    this.rxWizardModalComponent.api.enableNextButton();\n  }\n}\n","<div class=\"d-flex justify-content-between\">\n  <h5 class=\"mt-0\">\n    {{\n      'com.bmc.arsys.rx.innovation-studio.bundle-action-wizard.select-approval-configurations.approval-configurations.label'\n        | translate\n    }}\n  </h5>\n  <div>\n    {{\n      'com.bmc.arsys.rx.innovation-studio.bundle-action-wizard.select-approval-configurations.approval-configurations-count.label'\n        | translate: { count: selectedDefinitionCount }\n    }}\n  </div>\n</div>\n\n<div class=\"mb-3\">\n  {{\n    'com.bmc.arsys.rx.innovation-studio.bundle-action-wizard.select-approval-configurations.selected-approval-configurations.label'\n      | translate\n  }}\n</div>\n\n<rx-record-grid [config]=\"recordGridConfig$\" (dataLoaded)=\"onDataLoaded()\"></rx-record-grid>\n"]}